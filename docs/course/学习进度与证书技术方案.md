# 学习进度与证书技术方案（DDD + MyBatis Plus + PostgreSQL）

状态：设计稿（部分已落地）  
最后更新：2025-10-01  
适用范围：课程（Course）子域，前台学习记录与完成标识颁发  
词汇口径：请先阅读 docs/glossary.md，文中“课程解锁”“套餐（Subscription Plan）”“功能权限码（PlanPermission）”等术语与其保持一致。  
索引：本方案已纳入 docs/README.md 的“课程”章节，可从总览进入。

## 1. 背景与目标
- 背景：付费社区，用户通过套餐访问课程等内容；希望实时记录用户学习过程，汇总课程完成度，并在完成后颁发“课程完成标识”（证书/徽章），为后续聊天室等功能提供依据与展示。
- 目标：
  - 按章节记录学习进度（百分比、观看位置、用时、最近学习时间）
  - 汇总用户的课程完成度（进度百分比、完成状态、完成时间）
  - 自动颁发课程完成标识（证书），支持查询与展示
  - 对接权限拦截（PlanPermission），确保只有有权用户才能上报/查看
  - 为后续“向完成用户提问/答疑路由”提供基础数据

## 2. 范围与非目标
- 范围：学习进度上报、课程进度汇总、证书（完成标识）颁发与查询、基础反作弊与限频。
- 非目标（后续迭代）：证书 PDF 渲染/打印、美化模板；细粒度学习事件明细分析（如完整行为回放/BI）。

## 3. 架构与分层（DDD）
与 docs/glossary.md 的分层职责一致：Application 仅编排流程与事务；Domain 执行业务规则与持久化；Infrastructure 提供技术支撑（锁、配置、迁移等）。
- Application（编排/事务/DTO/Assembler）：
  - CourseProgressAppService：进度上报、进度查询、学习面板
  - CourseCertificateAppService：证书查询/撤销（管理员）
- Domain（核心规则/Repository）：
  - course 子域：CourseProgressDomainService、CourseCertificateDomainService
  - Repository：UserChapterProgressRepository、UserCourseProgressRepository、CourseCertificateRepository（均继承 BaseMapper）
- Infrastructure：
  - Flyway 迁移（PostgreSQL）、类型转换器（如枚举）、分布式锁、定时任务（可选）
- 接口层（Interfaces）：
  - `/api/user/learning/...` 用户接口，绑定 Plan 权限注解；管理员接口 `/api/admin/...`

## 4. 权限与套餐（Plan）
与“课程解锁（Unlocked）”口径统一：只有“已解锁课程”（直购或套餐包含）的章节才允许上报学习进度与访问UV。功能权限码（PlanPermission）仅控制接口能力，与解锁正交。
- 新增权限码（建议）：
  - `LEARNING_PROGRESS_REPORT`（上报进度）
  - `LEARNING_PROGRESS_VIEW`（查看学习进度/面板）
  - `CERTIFICATE_VIEW`（查看证书）
  - `CERTIFICATE_MANAGE`（管理员撤销证书）
- 免费套餐可限制为“仅试看章节允许上报进度/展示预估进度”，完整进度/证书需付费套餐解锁。

## 5. 数据模型与迁移（PostgreSQL）
> 命名规范：主键 `id VARCHAR(36)`（UUID），`create_time / update_time` 自动填充，软删除字段 `deleted_at TIMESTAMP NULL`；与项目一致。

### 5.1 user_chapter_progress（章节层进度状态）
字段（核心）：
- `id`，`user_id`，`course_id`，`chapter_id`
- `progress_percent SMALLINT`（0–100，仅递增）
- `last_position_sec INT`（视频/音频当前位置，仅递增）
- `time_spent_sec INT`（累计学习时长，服务端按 delta 增量累加）
- `last_access_time TIMESTAMP`（最近学习时间）
- `completed_at TIMESTAMP`（章节完成时间，满足完成规则时赋值）
- `create_time / update_time / deleted_at`

约束与索引：
- 唯一：`UNIQUE (user_id, chapter_id) WHERE deleted_at IS NULL`
- 索引：`(user_id)`、`(course_id)`、`(chapter_id)`、`(last_access_time)`

### 5.2 user_course_progress（课程层汇总状态）
字段（核心）：
- `id`，`user_id`，`course_id`
- `total_chapters INT`（快照）
- `completed_chapters INT`
- `progress_percent SMALLINT`（归一化百分比）
- `last_access_chapter_id`，`last_access_time`（最近学习位置）
- `completed_at TIMESTAMP`（课程完成时间）
- `create_time / update_time / deleted_at`

约束与索引：
- 唯一：`UNIQUE (user_id, course_id) WHERE deleted_at IS NULL`
- 索引：`(user_id)`、`(course_id)`、`(completed_at)`

### 5.3 course_certificates（课程完成标识/证书）
字段（核心）：
- `id`，`user_id`，`course_id`
- `certificate_no VARCHAR(50)`（唯一编号，可按规则生成）
- `status`（枚举：ISSUED/REVOKED）
- `issued_at TIMESTAMP`，`revoked_at TIMESTAMP`，`meta JSONB`（可扩展）
- `create_time / update_time / deleted_at`

约束与索引：
- 唯一：`UNIQUE (user_id, course_id) WHERE deleted_at IS NULL`
- 唯一：`UNIQUE (certificate_no)`

### 5.4 Flyway 迁移建议
- 新增迁移文件：
  - `V52__Create_user_learning_progress_tables.sql`
  - `V53__Create_course_certificates_table.sql`
- 均使用 PostgreSQL 语法；高频条件字段（user_id/course_id/last_access_time）添加索引。

## 6. 领域设计与规则
### 6.1 CourseProgressDomainService
- `updateChapterProgress(userId, courseId, chapterId, newPercent, lastPosSec, deltaTimeSec)`
  - 只增不减：`progress_percent = max(old, new)`；`last_position_sec = max(old, new)`
  - `time_spent_sec += safeDelta`（对 delta 做上限，避免刷时长）
  - `last_access_time = now()`；当章节达到完成阈值（如 ≥95%）→ 设置 `completed_at = now()`
  - Upsert 写入 `user_chapter_progress`
  - 之后：`recalcCourseProgress(userId, courseId)` 更新课程汇总
- `recalcCourseProgress(userId, courseId)`：
  - 查询章节总数（`ChapterRepository`），统计用户完成章节数
  - 计算 `progress_percent`（`ceil(completed/total * 100)` 或平均百分比）
  - 维护 `last_access_*` 快照；若全部完成 → `completed_at = now()`

### 6.2 CourseCertificateDomainService
- `issueIfEligible(userId, courseId)`：
  - 若 `user_course_progress.completed_at` 存在且未发证 → 生成 `certificate_no` 并插入 `course_certificates`（`status=ISSUED`）
- `revoke(certificateId, reason)`（管理员）：设置 `status=REVOKED`，`revoked_at=now()`

### 6.3 规则细节
- 完成阈值：
  - 视频类章节：`progress_percent >= 95%` 记为完成（保留跳尾容忍）
  - 图文类章节：滚动阈值 ≥95% 或最小阅读时长达标
  - 课程完成：全部章节完成（推荐）
- 并发与幂等：
  - 可使用分布式锁（按 userId+chapterId）或“仅更大值”的乐观更新写法，保证幂等
  - 允许重复上报；服务端只做增量累积

## 7. 应用层设计（编排）
### 7.1 CourseProgressAppService
- `reportChapterProgress(ReportChapterProgressRequest req, String userId)`：
  - 前置校验：章节属于课程、用户具备访问权限（订阅/试看）；限频（同章节≥5s）
  - 调用 `CourseProgressDomainService.updateChapterProgress`
  - 若课程完成，调用 `CourseCertificateDomainService.issueIfEligible`
  - 返回 `CourseProgressDTO`（聚合进度 + 是否已发证）
- `getMyCourseProgress(String courseId, String userId)`：查询 `user_course_progress` 并组合证书状态
- `getMyLearningDashboard(String userId, Page)`：按最近学习/完成时间排序、分页返回

### 7.2 CourseCertificateAppService
- `getMyCertificates(String userId)`、`getCertificateDetail(String certificateId, String userId)`
- 管理员：`revokeCertificate(String certificateId, String adminId)`

## 8. 接口设计（Interfaces）
与 PlanPermission 拦截器配合，遵循“接口权限码”与“课程解锁”双重校验：未解锁课程不可上报；无权限码不可调用能力型接口。
- `POST /api/user/learning/progress/report`
  - Body：`{ courseId, chapterId, progressPercent, lastPositionSec, timeSpentSec }`
  - 权限：`LEARNING_PROGRESS_REPORT`
- `GET /api/user/learning/progress/{courseId}`
  - 权限：`LEARNING_PROGRESS_VIEW`
- `GET /api/user/learning/dashboard?pageNum=&pageSize=`
  - 权限：`LEARNING_PROGRESS_VIEW`
- `GET /api/user/certificates`
  - 权限：`CERTIFICATE_VIEW`
- `GET /api/user/certificates/{certificateId}`
  - 权限：`CERTIFICATE_VIEW`
- `DELETE /api/admin/certificates/{id}`（撤销）
  - 权限：管理员 + `CERTIFICATE_MANAGE`

DTO 建议：
- `ReportChapterProgressRequest`、`CourseProgressDTO`、`LearningDashboardItemDTO`、`CourseCertificateDTO`

## 9. 反作弊与限频
- 限频：同用户同章节上报最小间隔（如 5s），使用 Redis 记录上次受理时间
- delta 上限：`time_spent_sec` 的单次增量 ≤ 心跳周期 + 容差
- 参数校验：position、percent 数值范围；章节归属与访问权限验证
- 试看限制：免费用户仅允许在试看章节上报

## 10. 性能与存储
- 核心写入为 upsert（章节状态 + 课程汇总），字段与索引覆盖高频查询条件
- 大量细粒度事件（如每秒心跳）不建议全部落库，可在客户端节流（5–10s）并服务端限频
- 如需 BI：可新增 `learning_activity_logs` 事件表或导出到独立分析库

## 11. 通知与事件
- 学完课程：触发站内通知（已存在 NotificationDomainService），模板“恭喜完成《{课程名}》，证书编号 {no}”
- 可扩展订阅上新提醒、继续学习提醒（基于 `last_access_time`）

## 12. 与聊天室的衔接
- 完成课程（有证书）的用户在课程聊天室展示“已完成/已认证”标识
- 提问路由：根据 `courseId` 从“完成用户/导师”中选择在线/活跃用户，按评分/活跃度排序推荐

## 13. 实施步骤与任务拆分
1) Flyway：`V52__Create_user_learning_progress_tables.sql`、`V53__Create_course_certificates_table.sql`
2) Domain：实体 + Repository + `CourseProgressDomainService` + `CourseCertificateDomainService`
3) Application：`CourseProgressAppService`、`CourseCertificateAppService` + Assembler/DTO
4) Interfaces：Controller 路由与 `@RequiresPlanPermissions` 注解
5) 通知模板与集成（完成时发送）
6) 前端接入：播放心跳/滚动阈值打点上报；Dashboard 展示

## 14. 验收标准（示例）
- 学习进度上报幂等：重复上报不回退、不重复计时
- 课程进度与章节完成规则准确，新增章节后重新计算符合预期
- 达成完成条件自动颁发证书；证书唯一且可查询
- 权限与限频生效：试看章节外免费用户无法上报；高频打点被限流

## 15. 后续迭代方向

## 16. 关键代码路径（便于查阅）
- 迁移：
  - `src/main/resources/db/migration/V52__Create_user_learning_progress_tables.sql`
  - `src/main/resources/db/migration/V53__Create_course_certificates_table.sql`
  - `src/main/resources/db/migration/V47__Create_user_access_tables.sql`
- 领域层：
  - 进度：`domain/course/service/CourseProgressDomainService.java`
  - 证书：`domain/course/service/CourseCertificateDomainService.java`
  - 访问UV：`domain/course/service/CourseAccessDomainService.java`
  - 实体/仓储：`domain/course/entity/*`、`domain/course/repository/*`
- 应用层：
  - `application/course/service/CourseProgressAppService.java`
  - `application/course/service/CourseAccessAppService.java`
- 接口层：
  - `interfaces/course/controller/UserLearningController.java`

## 17. 前端对接指南（视频/图文章节）

- 鉴权与权限
  - 统一携带 `Authorization: Bearer <JWT>` 访问接口；未登录/无效返回 401；被禁用/无订阅返回 403。
  - 接口受功能权限码与课程解锁双重保护：未解锁课程或未授予权限码将被拦截（详见 docs/glossary.md 的口径）。

注：页面访问/浏览 UV 由“活动日志/操作日志”模块统一记录与统计，本方案不再提供单独的 UV 上报接口，详见 docs/activity 下相关文档与接口。

- 进度上报（心跳/关键节点）
  - 接口：`POST /api/user/learning/progress/report`
  - 请求体（秒为单位，整数即可）：
    - `courseId`：课程ID（必填）
    - `chapterId`：章节ID（必填）
    - `progressPercent`：学习进度 0–100（必填；前端估算，后端取 max）
    - `positionSec`：当前播放/阅读位置秒数（可选；视频推荐填）
    - `timeSpentDeltaSec`：自上次上报以来“真实学习用时”的增量秒数（可选；建议传）
  - 上报时机（视频）：
    - 心跳：播放中每 5–10 秒上报一次（建议 8–10 秒，前端节流保证最短间隔 ≥5 秒）
    - 关键节点：`play`/`pause`/`seeked`/`ended` 事件立即上报一次，确保状态刷新
  - 上报时机（图文）：
    - 进入页面：上报一次（`progressPercent` 可为 0）
    - 滚动阈值：到达 25%/50%/75%/95% 时各上报一次
    - 离开/失焦：上报一次，将停留时长换算为 `timeSpentDeltaSec`
  - 建议：结束/离开前（`beforeunload`/`visibilitychange`）尽量触发一次上报，弱网下仍有丢失可能，下一次进入会追平。

- 查询课程进度（用于详情页/学习面板）
  - 接口：`GET /api/user/learning/progress/{courseId}`
  - 返回：课程汇总进度（总章节数、已完成章节数、百分比、是否完成、证书是否已颁发、最近学习位置与时间）。

- 前端实现要点
  - 视频：
    - 以 HTML5 video 元素事件为触发点：`timeupdate`（配合节流作为心跳）、`play`、`pause`、`seeked`、`ended`。
    - `positionSec`: `Math.floor(video.currentTime)`；`timeSpentDeltaSec`: 两次上报的“实际播放时间差”（暂停/后台不计）。
    - `progressPercent`: `Math.round((currentTime/duration)*100)`；最终以后端“权威时长”核验为准。
  - 图文：
    - `progressPercent` 可由“滚动条位置/内容可视区域”估算；
    - `timeSpentDeltaSec` 建议用“活动时间”而非纯停留时间（可结合页面可见性与用户交互）。
  - 防抖与容错：
    - 同一章节间隔 <5s 的打点可在前端丢弃；
    - 断网可缓存打点并批量补发；服务端按“只增不减 + 增量上限”合并，重复/乱序无碍。

- 示例请求（JSON）
  - 心跳：
    - `POST /api/user/learning/progress/report`
    - Body: `{ "courseId": "c_123", "chapterId": "ch_456", "progressPercent": 42, "positionSec": 125, "timeSpentDeltaSec": 8 }`
  - 章节访问UV：
    - `POST /api/user/learning/access/chapter`
    - Body: `{ "courseId": "c_123", "chapterId": "ch_456" }`

- 常见问答（Q&A）
  - Q：倍速播放如何计时？
    - A：完成度以“覆盖率”为主（基于 position/duration），时间仅作参考门槛；`timeSpentDeltaSec` 写入实际播放时间。
  - Q：用户快进会不会直接完成？
    - A：不会。后端按“只增不减 + 完成阈值 +（可选）最小有效时长”判定，快进不足以达到完成条件。
  - Q：如果结束/离开没上报会丢数据吗？
    - A：心跳会在下一次进入时追平；精准到秒并非必要，系统以 5–10 秒采样作为折中。


- 证书 PDF/可视化模板、分享卡片
- 学习 streak（连续学习天数）与积分/任务联动
- 题库联动：章节完成→解锁题集；答题正确率纳入完成评估
- A/B 实验：不同完成阈值/打点策略对留存与转化的影响
