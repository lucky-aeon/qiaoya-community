# 课程权限体系技术文档

作者：后端
最后更新：2025-09-27
状态：已落地（持续演进）
适用范围：课程/章节接口访问控制、前台解锁标记、套餐-课程绑定编排
关键代码路径：见第2节“分层与主要模块”

## 目录
- 0. 业务背景
- 1. 范围与目标
- 2. 分层与主要模块
- 3. 数据模型与迁移
- 4. 实现方案（总览）
- 7. 购买/激活链路（事件驱动）
- 8. 管理端：套餐与课程绑定
- 9. 错误码与异常
- 10. 关键约束与约定
- 11. 后续工作（资源级访问控制）
- 附录：历史方案差异对比

## 0. 业务背景

我们是“付费社区”场景：
- 为了支持不同营销方案，平台提供多个订阅套餐，不同套餐可访问的课程范围不同（套餐粒度差异化）。
- 为促进消费，课程支持“单独购买”（不依赖套餐），用户单购后应立即拥有该课程的访问权限。
- 因此需要统一的“课程权限管控”能力：既满足套餐差异化授权，也支持单课直购授权，并在前台接口清晰反馈“是否已解锁”。

## 1. 范围与目标

本技术文档覆盖“课程权限”的整体方案，包含：
- 课程与套餐绑定（管理员配置）。
- 课程解锁判定（直购/套餐解锁）。
- 前台接口的解锁标记返回（列表/详情）。
- 章节访问的权限校验。
- 购买/激活链路（CDK → 授权 → 订单记录）。

不在本次文档范围：
- 资源级访问控制与资源绑定（见《课程资源绑定设计方案.md》，为后续增强）。

## 2. 分层与主要模块

- 接口层（Interfaces）
  - 前台课程：`src/main/java/org/xhy/community/interfaces/course/controller/AppCourseController.java`
  - 前台章节：`src/main/java/org/xhy/community/interfaces/course/controller/AppChapterController.java`
  - 管理套餐-课程绑定：`src/main/java/org/xhy/community/interfaces/subscription/controller/AdminSubscriptionPlanCourseController.java`

- 应用层（Application）
  - 课程查询编排：`src/main/java/org/xhy/community/application/course/service/CourseAppService.java`
  - 章节查询编排（含权限校验）：`src/main/java/org/xhy/community/application/course/service/ChapterAppService.java`
  - 管理端套餐-课程绑定：`src/main/java/org/xhy/community/application/subscription/service/AdminSubscriptionPlanCourseAppService.java`
  - 用户订阅：`src/main/java/org/xhy/community/application/subscription/service/UserSubscriptionAppService.java`
  - 监听器（授权/下单）：
    - 课程CDK → 授权课程：`src/main/java/org/xhy/community/application/course/listener/CourseCDKEventListener.java`
    - 任意CDK → 订单记录：`src/main/java/org/xhy/community/application/order/event/OrderEventHandler.java`

- 领域层（Domain）
  - 课程与章节：`src/main/java/org/xhy/community/domain/course/service/*`
  - 用户直购课程（权限实体）：`src/main/java/org/xhy/community/domain/user/entity/UserCourseEntity.java`
  - 用户课程权限服务：`src/main/java/org/xhy/community/domain/user/service/UserDomainService.java`
  - 套餐、用户订阅与绑定：`src/main/java/org/xhy/community/domain/subscription/service/*`
  - CDK 激活：`src/main/java/org/xhy/community/domain/cdk/service/CDKDomainService.java`
  - 订单：`src/main/java/org/xhy/community/domain/order/service/OrderDomainService.java`

- 基础设施（Infrastructure）
  - 登录与有效订阅校验：`src/main/java/org/xhy/community/interfaces/webconfig/UserContextInterceptor.java`
  - 功能码权限拦截：`src/main/java/org/xhy/community/interfaces/webconfig/PlanPermissionInterceptor.java`
  - 用户上下文：仅 Controller 可用：`src/main/java/org/xhy/community/infrastructure/config/UserContext.java`

## 3. 数据模型与迁移

- 课程：`courses`（已有）
- 章节：`chapters`（已有）
- 用户直购课程：`user_courses`（记录用户直接拥有的课程权限）
- 套餐：`subscription_plans`（状态 ACTIVE/INACTIVE）
- 套餐-课程绑定：`subscription_plan_courses`（套餐包含的课程）
- 用户订阅：`user_subscriptions`（记录用户的有效订阅及所属套餐）
- 订单：`orders`（记录CDK激活等来源的订单）

迁移位置：`src/main/resources/db/migration`（Flyway，PostgreSQL）。
命名规范：`V{version}__{description}.sql`

索引建议：
- `subscription_plan_courses(subscription_plan_id, course_id, deleted)` 唯一索引，避免重复绑定。

## 4. 实现方案（总览）

围绕“课程解锁”这个核心判定，落地如下：
- 管理端绑定：管理员在后台将课程绑定到订阅套餐（文件：`interfaces/subscription/controller/AdminSubscriptionPlanCourseController.java`，`application/subscription/service/AdminSubscriptionPlanCourseAppService.java`，`domain/subscription/service/SubscriptionPlanDomainService.java`）。
- 用户授权来源：
  - 直购（或课程CDK激活）→ 写入用户课程权限表 `user_courses`。
  - 套餐（或套餐CDK激活）→ 写入用户订阅表 `user_subscriptions`，并以绑定表 `subscription_plan_courses` 推导课程授权。
- 前台列表/详情：
  - 列表返回 `unlocked` 标记（`CourseAppService#queryAppCourses`）。
  - 详情返回 `unlocked`，未解锁时返回 `unlockPlans`（所有绑定该课程且 ACTIVE 的套餐），用于前端展示“价格购买/套餐购买”（`CourseAppService#getAppCourseDetail`）。
- 章节访问：进入章节详情前进行课程级授权校验（`ChapterAppService#getChapterById`）。
- 事件驱动：
  - `CDKDomainService#activateCDK` 发布事件。
  - 课程CDK → 授课授权（`application/course/listener/CourseCDKEventListener.java`）。
  - 套餐CDK → 创建用户订阅（`application/subscription/listener/SubscriptionCDKEventListener.java`）。
  - 任意CDK → 订单落库（`application/order/event/OrderEventHandler.java`）。
- 分层约束：Controller 解析 `userId` 并向下传参；Application 只编排；Domain 只做规则/持久化；Assembler 只做对象转换。

## 5. 权限模型与判定流程

权限分三层：
1) 全局认证与“有效订阅”拦截：`UserContextInterceptor`（所有受控接口前置检查）。
2) 接口功能权限（PlanPermissionInterceptor + @RequiresPlanPermissions）：限制接口访问能力。
3) 课程级授权（本方案新增/改造重点）：基于“直购/套餐绑定”判断是否解锁具体课程/章节。

课程解锁规则（UNLOCKED）：
- 用户已直接拥有该课程（`user_courses`），或
- 用户当前任一“有效订阅”的套餐包含该课程（`subscription_plan_courses`）。

批量优化：
- 领域层新增：`SubscriptionPlanDomainService.getCourseIdsByPlanIds(Collection<String>)`，一次查询返回多套餐的课程ID集合，用于列表批量标记。
- 领域层新增：`SubscriptionPlanDomainService.getPlansByCourseId(String)`，详情页未解锁时返回可解锁的套餐列表。

## 6. 前台接口行为

- 课程列表
  - 路由：`POST /api/app/courses/queries`
  - 控制器：`AppCourseController#queryCourses`
  - 应用层：`CourseAppService#queryAppCourses(AppCourseQueryRequest, String userId)`
  - 返回 DTO：`FrontCourseDTO`（`src/main/java/org/xhy/community/application/course/dto/FrontCourseDTO.java`）
    - 字段：`unlocked: Boolean`（已解锁与否）
  - 标记策略：应用层编排合并“直购课程 + 有效订阅套餐课程”后，对当页课程批量标注。
  - 说明：userId 由 Controller 传入，App 层不直接使用 `UserContext`。

- 课程详情
  - 路由：`GET /api/app/courses/{id}`
  - 控制器：`AppCourseController#getCourseDetail`
  - 应用层：`CourseAppService#getAppCourseDetail(String courseId, String userId)`
  - 返回 DTO：`FrontCourseDetailDTO`（`src/main/java/org/xhy/community/application/course/dto/FrontCourseDetailDTO.java`）
    - 字段：`unlocked: Boolean`、`unlockPlans: List<AppSubscriptionPlanDTO>`
      - 若未解锁，`unlockPlans` 返回所有“绑定该课程且 ACTIVE 的套餐”用于前端展示“价格购买/套餐购买”。

- 章节详情
  - 路由：`GET /api/app/chapters/{id}`
  - 控制器：`AppChapterController#getChapterDetail`
  - 应用层：`ChapterAppService#getChapterById(String chapterId, String userId)`
    - 内部调用 `validateChapterAccess(courseId, userId)`：
      - 先判直购；再判用户有效订阅所含课程（使用批量查询方法）。
      - 未通过抛出：`CourseErrorCode.CHAPTER_ACCESS_DENIED`。

## 7. 购买/激活链路（事件驱动）

- CDK 激活入口：`CDKDomainService#activateCDK`
  - 发布事件：`CDKActivatedEvent`（包含用户、类型、目标ID、获得方式等）。

- 课程CDK → 授权课程
  - 监听器：`application/course/listener/CourseCDKEventListener.java`
  - 行为：校验课程存在 → `UserDomainService.grantCourseToUser(userId, courseId)` → 用户获得直购权限。

- 套餐CDK → 生成用户订阅
  - 监听器：`application/subscription/listener/SubscriptionCDKEventListener.java`
  - 行为：`SubscriptionDomainService.createSubscriptionFromCDK(userId, planId, cdk)` → 产生有效订阅。

- 订单记录（统一）
  - 监听器：`application/order/event/OrderEventHandler.java`
  - 行为：根据事件类型写入 `orders` 表，用于对账与审计。

## 8. 管理端：套餐与课程绑定

- 控制器：`interfaces/subscription/controller/AdminSubscriptionPlanCourseController.java`
- 应用层：`application/subscription/service/AdminSubscriptionPlanCourseAppService.java`
- 领域层：`domain/subscription/service/SubscriptionPlanDomainService.java`
- 能力：获取套餐/课程列表、查询套餐已绑课程ID、全量同步套餐课程绑定。

## 9. 错误码与异常

- 统一位置：`src/main/java/org/xhy/community/infrastructure/exception`
- 课程相关：`CourseErrorCode`
  - `COURSE_NOT_FOUND`、`CHAPTER_NOT_FOUND`、`CHAPTER_ACCESS_DENIED`、`COURSE_ACCESS_DENIED`
- 订阅相关：`SubscriptionErrorCode`、`SubscriptionPlanErrorCode`
- 订单相关：`OrderErrorCode`
- 规范：在对应层抛出业务异常并交由全局异常处理。

## 10. 关键约束与约定

- 分层调用约束：Application → Domain（仅此）；Domain 不调 Application；Assembler 只做对象转换。
- App 层禁止直接读取 `UserContext`，由 Controller 解析并向下传递 `userId`。
- 列表标记仅做当前页批量判定，避免 N+1；详情/内容接口做强校验。
- 套餐有效性与功能码权限由拦截器统一兜底；课程级授权在应用层精确判定。

## 11. 后续工作（资源级访问控制）

- 文档：`课程资源绑定设计方案.md`
- 核心思路：新增 `resource_bindings` 绑定资源与章节/课程；资源访问入口在生成直链前做“课程解锁”校验；章节编辑时同步绑定。

## 附录：历史方案差异对比（归档参考）

- 与《课程访问控制（套餐绑定）设计方案》差异：本篇作为收敛后的权威方案，明确“解锁判定在应用层编排，列表走批量标记避免 N+1”，并补齐事件链路与错误码规范；历史草案仅提供早期“未绑定=免费”的判定视角，现作为参考保留。
- 与《CDK激活权限管理系统实现方案》差异：本篇统一了“直购（静态）+ 套餐（动态）”的权限来源与查询职责边界，避免复制权限导致的变更不同步问题；历史文档保留作为演进背景说明。
- 统一分层：本篇严格遵循 Application→Domain→Repository 的依赖束缚，禁止跨层调用；Assembler 仅做对象转换。
