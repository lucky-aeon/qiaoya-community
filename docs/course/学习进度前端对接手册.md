# 学习进度前端对接手册（前台用户端）

状态：设计稿（已可对接）  
最后更新：2025-10-02  
适用范围：前台课程章节页（视频/图文），与后端“学习进度与证书技术方案”配套  
术语口径：请先阅读 docs/glossary.md（课程解锁、PlanPermission 等）

---

## 1. 总览与目标
- 记录“用户学到了哪一步（进度）”“本次新增看了多久（秒）”，便于：
  - 展示课程/章节进度
  - 达成完成阈值后自动颁发完成标识
  - 统计投入时长（反作弊）

核心字段：
- `progressPercent`（0–100，整数）——这一章的覆盖进度百分比的快照（只升不降）
- `positionSec`（整数，单位秒，可选，但视频章节必须上传）——视频当前播放秒点
- `timeSpentDeltaSec`（整数，单位秒）——“自上次上报以来”新增的有效观看时长（增量）

注意：`progressPercent` ≠ `timeSpentSec`，一个是“覆盖率”，一个是“时间投入”。

---

## 2. 接口与权限
- 身份：`Authorization: Bearer <JWT>`
- 权限：接口拦截器校验功能权限码（PlanPermission）与课程解锁（直购/套餐）。

接口列表：
- 上报：`POST /api/user/learning/progress/report`
  - Body:
    ```json
    {
      "courseId": "c_123",
      "chapterId": "ch_456",
      "progressPercent": 42,
      "positionSec": 125,              // 视频章节必须上传；图文可不传
      "timeSpentDeltaSec": 8           // 自上次上报以来新增的秒数
    }
    ```
- 查询课程汇总：`GET /api/user/learning/progress/{courseId}`
- 学习记录（分页）：`GET /api/user/learning/records?pageNum=1&pageSize=10`

---

## 3. 上报时机与策略

### 3.1 视频章节
- 心跳：播放中每 5–10 秒上报一次（建议 8–10s；前端最短不要低于 5s）
- 关键节点：`play`/`pause`/`seeked`/`ended` 事件立即上报一次
- 离开/切页：`visibilitychange`/`pagehide`/`beforeunload` 时尽量 flush 一次

字段计算：
- `positionSec = Math.floor(video.currentTime)`（必须上传）
- `progressPercent = Math.round((video.currentTime / video.duration) * 100)`
- `timeSpentDeltaSec =` 上次上报到本次上报之间“实际播放”的秒数（暂停/后台不计）
  - 可通过监听 `timeupdate` 与 `paused`/`visibilitychange` 状态，累计“播放状态下”的秒差

注意：快进不会被直接判为完成；后端会以“覆盖率阈值（默认≥95%）+（可选）最小时长门槛”判定完成，且采用“只增不减”合并。

### 3.2 图文章节（无视频）
- 滚动阈值：到达 25%/50%/75%/95% 各上报一次
- 停留时长：离开/失焦时上报本次停留的秒数（`timeSpentDeltaSec`）
- 组合进度：`progressPercent = max(滚动百分比, 时间推进百分比)`
  - 时间推进百分比可参考“预计阅读时长”（readingTime×60），`Math.floor(elapsed / readingSeconds * 100)`

---

## 4. 字段含义与校验
- `progressPercent`：0–100 的整数；建议 `Math.round/Math.floor` 后上传
  - 后端会取历史值与本次值的最大值（只增不减）
- `positionSec`：视频当前位置秒数（整数）；视频章节必须上传；图文可不传
- `timeSpentDeltaSec`：自上次上报以来新增的有效观看秒数（整数、增量）
  - 不要上传“累计秒数”；必须是“增量秒”；暂停/后台时为 0
  - 后端会对单次增量做上限裁剪（约心跳间隔+容差），防断网后一次注入大量秒

---

## 5. 示例代码（TypeScript）

### 5.1 视频章节（核心片段）
```ts
const getProgress = () => {
  if (!videoRef.current) return null;
  const el = videoRef.current as HTMLVideoElement;
  const now = Date.now();
  if (!lastTickTsRef.current) lastTickTsRef.current = now;
  const deltaSec = el.paused || document.visibilityState === 'hidden'
    ? 0
    : Math.max(0, Math.round((now - lastTickTsRef.current) / 1000));
  lastTickTsRef.current = now;
  const positionSec = Math.floor(el.currentTime);
  const progressPercent = Math.max(0, Math.min(100, Math.round((el.currentTime / (el.duration || 1)) * 100)));
  return { progressPercent, positionSec, timeSpentDeltaSec: deltaSec > 0 ? deltaSec : undefined };
};

useChapterProgressHeartbeat({ courseId, chapterId, getProgress, intervalSec: 10, enabled: true });
```

### 5.2 图文章节（配合滚动阈值）
```ts
const { maxPercent: scrollPercent } = useScrollProgress({ containerSelector: '.prose-content' });
const getProgress = () => {
  const now = Date.now();
  if (!startTsRef.current) startTsRef.current = now;
  let deltaSec = 0;
  if (lastTickTsRef.current) deltaSec = Math.max(0, Math.round((now - lastTickTsRef.current) / 1000));
  else deltaSec = Math.max(0, Math.round((now - startTsRef.current) / 1000));
  lastTickTsRef.current = now;
  elapsedRef.current += deltaSec;
  const readingSeconds = (readingTime || 0) * 60;
  const timePercent = readingSeconds > 0 ? Math.floor((elapsedRef.current / readingSeconds) * 100) : 0;
  const percent = Math.min(100, Math.max(Math.floor(scrollPercent || 0), timePercent));
  return { progressPercent: percent, timeSpentDeltaSec: deltaSec > 0 ? deltaSec : undefined };
};
```

---

## 6. 常见问题（FAQ）
- Q：为什么课程卡片仍显示 0%？
  - A：后端“课程进度”默认口径是“已完成章节占比”（完成阈值默认≥95%）；未达阈值视为未完成，课程进度可能显示 0%。如需展示“部分进度”，后端可新增“平均进度”字段供前端显示（不影响发证判定）。

- Q：time_spent_sec 为什么可能很大？
  - A：它是“累计有效观看时长（秒）”，不是百分比，会随心跳累加。UI 建议格式化为 mm:ss 显示。

- Q：seek 到结尾是否立刻完成？
  - A：不会。后端按覆盖率阈值（默认≥95%）+（可选）最小有效时长判定完成，并以“只增不减”合并，快进不足以直接获得完成。

---

## 7. 对接检查清单
- [ ] 视频章节每次上报是否包含 `positionSec`
- [ ] `timeSpentDeltaSec` 是否为“增量秒”（暂停/后台为 0）
- [ ] 心跳间隔 ≥ 5s，且 `play/pause/seeked/ended` 事件立即上报
- [ ] 离开/切页前尝试 flush 最后一笔
- [ ] 图文章节上报滚动阈值与离开时停留时长

如需“课程卡片展示部分进度”，请对接后端“平均进度”字段（可按需加），或在前端做提示文案说明默认口径。

