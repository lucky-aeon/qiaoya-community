# 课程访问控制（套餐绑定）设计方案

作者：后端
状态：归档（历史草案）
最后更新：2025-09-27
适用范围：历史背景/对比；当前以《课程权限体系技术文档.md》为权威方案

维护人：后端
权威文档：docs/课程权限体系技术文档.md

## 1. 背景与目标

需求回顾：
- 套餐可以绑定课程；被绑定的课程只能由该套餐（或满足条件的套餐）用户观看。
- 若课程没有被任何套餐绑定，则视为免费课程，所有有登录且有效套餐的用户可观看。
- 课程也支持“直接购买”后观看（不依赖套餐）。
- 对课程做访问控制；课程下的章节与课程同一规则；资源 ID 暂不纳入本轮改造范围。
- 每个用户一定会有一个有效套餐，`UserContextInterceptor` 里的订阅有效性校验保留。

目标：
- 在不破坏现有 DDD 分层和权限码拦截（功能码）的基础上，补齐“按课程绑定/直购”的访问控制闭环。

不在本次范围：
- 资源访问按课程的强关联与鉴权（暂不处理）。
- 支付流程（CDK 激活链路已打通）。

## 2. 现状梳理（代码定位）

- 套餐-课程绑定
  - 表：`src/main/resources/db/migration/V10__Create_subscription_plan_courses_table.sql`
  - 领域实体与仓储：
    - `org.xhy.community.domain.subscription.entity.SubscriptionPlanCourseEntity`
    - `org.xhy.community.domain.subscription.repository.SubscriptionPlanCourseRepository`
  - 管理端绑定接口：
    - 控制器：`src/main/java/org/xhy/community/interfaces/subscription/controller/AdminSubscriptionPlanCourseController.java`
    - 应用层：`src/main/java/org/xhy/community/application/subscription/service/AdminSubscriptionPlanCourseAppService.java`
  - 领域服务（已有）：
    - 全量同步绑定：`src/main/java/org/xhy/community/domain/subscription/service/SubscriptionPlanDomainService.java`
    - 取某套餐的课程ID：同上
    - 判断某套餐是否包含指定课程：同上

- 直购能力
  - 表：`src/main/resources/db/migration/V14__Create_user_courses_table.sql`
  - 用户课程权限领域：
    - `org.xhy.community.domain.user.entity.UserCourseEntity`
    - `org.xhy.community.domain.user.service.UserDomainService`（授予/检查/查询直购课程）
  - 通过 CDK 激活授予课程权限：
    - 监听：`src/main/java/org/xhy/community/application/course/listener/CourseCDKEventListener.java`
    - 落单：`src/main/java/org/xhy/community/application/order/event/OrderEventHandler.java`

- 权限与拦截器
  - 用户上下文与“必须有有效订阅”：`src/main/java/org/xhy/community/interfaces/webconfig/UserContextInterceptor.java`
  - 功能码拦截：`src/main/java/org/xhy/community/interfaces/webconfig/PlanPermissionInterceptor.java`
  - 课程/章节接口当前仅做功能码拦截（未做按课程授权判定）：
    - 课程详情：`src/main/java/org/xhy/community/interfaces/course/controller/AppCourseController.java`
    - 章节详情：`src/main/java/org/xhy/community/interfaces/course/controller/AppChapterController.java`

- 用户课程访问权限应用服务（已存在但未接入到接口）：
  - `src/main/java/org/xhy/community/application/permission/service/UserPermissionAppService.java`
    - 现逻辑：直购优先、其后检查“有效订阅的套餐是否包含课程”。
    - 未覆盖“课程未绑定=免费”的判断。

## 3. 设计原则

- DDD 分层约束：
  - Application 仅编排流程与 DTO 转换；Domain 负责规则与持久化。
  - Application → Domain Service；Domain Service → Repository；各层不越权。
- 与现有功能码（PlanPermission）正交：
  - 功能码用于“能否访问某类接口（列表/详情）”。
  - 本设计用于“能否访问具体课程/章节内容（与绑定/直购有关）”。
- 性能优先级：
  - 列表接口不做逐条访问授权判断，避免 N+1；在详情/内容接口做精确拦截。
  - 若需要列表标记可访问性，另行提供批量判定接口或延后优化。

## 4. 方案概述

核心思路：在“课程详情”和“章节详情”接口返回内容前，引入按课程的访问判断：
1) 若课程未被任何套餐绑定 → 判定为免费 → 放行；
2) 否则（已被绑定）→ 允许直购用户或其任一有效订阅计划包含该课程的用户访问；其余拒绝。

落点：
- 领域层新增“课程是否被任一套餐绑定”的查询能力，以便 Application 层做“未绑定=免费”的前置判断。
- 应用层 `UserPermissionAppService.hasAccessToCourse` 接入“未绑定=免费”的规则。
- 接口层在课程详情、章节详情接口处调用应用层判定，不通过则抛业务异常。
- 功能码拦截保留，由运维/管理在套餐-功能码侧保障“有套餐的登录用户”具备访问这些接口的功能权限。

## 5. 详细设计

### 5.1 领域层（Domain）

- SubscriptionPlanDomainService 新增：
  - 方法：`boolean isCourseBoundToAnyPlan(String courseId)`
  - 说明：基于 `SubscriptionPlanCourseRepository` 查询是否存在 `course_id` 命中记录（遵循软删规则）。
  - 文件：`src/main/java/org/xhy/community/domain/subscription/service/SubscriptionPlanDomainService.java`

### 5.2 应用层（Application）

- UserPermissionAppService 调整：
  - 方法：`boolean hasAccessToCourse(String userId, String courseId)` 增加前置判断：
    - 若 `!isCourseBoundToAnyPlan(courseId)` → 返回 true；
    - 否则 → 返回 `hasDirectCourseAccess`（直购）或 `hasSubscriptionCourseAccess`（套餐包含）。
  - 文件：`src/main/java/org/xhy/community/application/permission/service/UserPermissionAppService.java`

- 可选增强：
  - `CourseAccessType getCourseAccessType(String userId, String courseId)`（FREE / DIRECT / PLAN / DENY），用于前端标记展示。

### 5.3 接口层（Interfaces）

- 在返回内容前做课程级访问控制（与功能码拦截配合）：
  - 课程详情：`AppCourseController.getCourseDetail(String id)` 调用 `hasAccessToCourse(currentUser, id)`；不通过抛业务异常。
  - 章节详情：`AppChapterController.getChapterDetail(String id)` 读取章节取 `courseId`，再调用 `hasAccessToCourse(currentUser, courseId)`；不通过抛业务异常。
  - 文件：
    - `src/main/java/org/xhy/community/interfaces/course/controller/AppCourseController.java`
    - `src/main/java/org/xhy/community/interfaces/course/controller/AppChapterController.java`

- 功能码拦截保留：
  - 课程详情功能码：`COURSE_APP_DETAIL`
  - 章节详情功能码：`CHAPTER_APP_DETAIL`
  - 文件：`src/main/java/org/xhy/community/interfaces/webconfig/PlanPermissionInterceptor.java`

### 5.4 错误码

- 建议新增：`COURSE_ACCESS_DENIED(5003, "无权限访问该课程")`
  - 文件：`src/main/java/org/xhy/community/infrastructure/exception/CourseErrorCode.java`

### 5.5 数据库与索引（建议）

- 为 `subscription_plan_courses` 增加唯一索引 `(subscription_plan_id, course_id, deleted)`，防止重复绑定：
  - 迁移：新增 `VXX__Add_unique_index_on_subscription_plan_courses.sql`

## 6. API 变更

- 路由不变；仅在现有接口中增加访问控制逻辑。
- 可选新增只读接口（若需要前端批量标记）：
  - `GET /api/app/courses/{id}/access` → 返回 `{ accessible: true|false, type: FREE|DIRECT|PLAN|DENY }`

## 7. 迁移与落地步骤

1) Domain：在 `SubscriptionPlanDomainService` 增加 `isCourseBoundToAnyPlan` 查询方法。
2) Application：在 `UserPermissionAppService.hasAccessToCourse` 接入“未绑定=免费”的前置判断。
3) Interfaces：在 `AppCourseController.getCourseDetail`、`AppChapterController.getChapterDetail` 接入口校验调用。
4) 错误码：为课程访问拒绝添加业务错误码并统一抛出。
5) 数据库（可选）：为 `subscription_plan_courses` 增唯一索引，避免重复绑定数据。
6) 联调与回归：确保功能码、全局订阅校验与课程级访问控制共同生效。

## 8. 测试用例（核心场景）

- 未绑定课程（免费）：
  - 用户有有效套餐（任意）→ 课程详情/章节详情可访问。

- 已绑定课程：
  - 用户无直购，且有效套餐不包含该课程 → 拒绝访问。
  - 用户直购该课程 → 允许访问。
  - 用户有效套餐包含该课程 → 允许访问。
  - 用户有多个有效订阅，只要任一订阅套餐包含课程 → 允许访问。

- 边界：
  - 课程/章节不存在 → `COURSE_NOT_FOUND` / `CHAPTER_NOT_FOUND`。
  - 数据软删除场景不影响 exists/查询（遵循 MyBatis Plus 全局配置）。

## 9. 风险与性能

- 访问控制放在详情接口，不影响列表性能。
- 若后续需要列表标记，可提供批量判定接口，并在应用层做缓存（courseId → isBoundToAnyPlan）。
- 与功能码叠加时，需确保相关功能码已分配给所有套餐，否则“免费课程”也可能因缺少功能码被拒绝。

## 10. 与现有拦截器的关系

- `UserContextInterceptor`：保留“必须有有效订阅”的前置校验（产品前提）。
- `PlanPermissionInterceptor`：保留现有功能码校验（接口级权限）。
- 新增的课程级访问控制：在具体课程/章节接口内部进行（资源层本轮不涉及）。

## 11. 后续可拓展

- 资源与课程/章节的强关联与访问控制（需要在 Resource 层引入 courseId/chapterId）。
- 列表接口增加访问状态字段（FREE/LOCKED/OWNED/BY_PLAN）。
- 更细粒度到“章节绑定”或“试听章节”策略（当前按课程整体控制）。
