# 课程直购-资源访问授权联动方案（额外资源访问权限）

作者：后端  
最后更新：2025-10-13  
状态：可实施（与现有方案兼容）  
适用范围：课程直购后的资源访问权限、资源访问口鉴权联动  
关联文档：
- docs/course/课程权限体系技术文档.md（权威：课程解锁判定）
- docs/course/课程资源绑定设计方案.md（资源→课程/章节绑定与访问口改造）

## 1. 背景与结论

背景：当前套餐分 free/plus/pro。free 不具备“资源访问能力”，但用户可以“单独购买课程”。购买后应能访问该课程下的资源（视频、附件等）。若仅依赖套餐能力，free 仍无法访问资源，出现“已购但看不了”的问题。

结论：不新增 basic 套餐；采用“额外资源访问授权”的方式落地。核心口径：
- 购买课程（或课程类 CDK 激活）后，给用户授予该课程作用域下的 `RESOURCE_DOWNLOAD` 权限（用户额外权限）。
- 鉴权采用“套餐功能码 + 用户额外权限”的并集：
  - 管理员放行；
  - 若套餐拥有功能码 `RESOURCE_DOWNLOAD` 且套餐包含该课程 → 放行；
  - 或用户拥有作用域为该课程的额外权限 `RESOURCE_DOWNLOAD@COURSE={courseId}` → 放行；
  - 否则拒绝。
- 不改变套餐层级模型，避免引入 basic。

统一判定公式（语义）：
`isAllowed = isAdmin || (planHas RESOURCE_DOWNLOAD ∧ planIncludesCourse) || userExtraHas(RESOURCE_DOWNLOAD@COURSE)`

说明：资源访问“是否属于课程/章节”通过绑定关系获得，绑定规则与流程见《课程资源绑定设计方案.md》。

## 2. 范围与非范围

范围：
- 资源访问鉴权联动（访问口采用“套餐功能码 + 用户额外权限”的并集）。
- 课程直购/激活成功后，授予用户额外权限 `RESOURCE_DOWNLOAD@COURSE={courseId}`（实现可复用 `user_courses`）。
- 退款/撤销时，撤销相应额外权限（仅影响直购授权，不影响套餐授权）。

非范围：
- 支付网关与订单细节（已有订单领域与事件流）。
- CDN/OSS 存储策略调整（保持现状）。
- 前端资源引用形态（需按《课程资源绑定设计方案.md》统一走访问口）。

## 3. 分层与主要模块（DDD）

- 接口层（Interfaces）
  - 资源访问入口：`src/main/java/org/xhy/community/interfaces/public_api/controller/PublicResourceController.java`

- 应用层（Application）
  - 资源访问编排：`src/main/java/org/xhy/community/application/resource/service/ResourceAppService.java`
    - `String getResourceAccessUrl(String resourceId, String userId)`（保持不变，仍以“资源→课程绑定 + 课程解锁”判定）
  - 课程访问判定复用：`src/main/java/org/xhy/community/application/permission/service/UserPermissionAppService.java`
    - `boolean hasAccessToCourse(String userId, String courseId)`（直购优先，再判套餐包含；未绑定课程=免费由权威文档定义）
    - 新增（建议）：`boolean hasDownloadPermissionForResource(String userId, String resourceId)`（并集判定）
  - 购买/退款链路：订单与课程授权事件监听（已存在，保持复用）

- 领域层（Domain）
  - 资源绑定：`src/main/java/org/xhy/community/domain/resourcebinding/*`
    - `ResourceBindingDomainService#getBoundCourseIdsByResource(String resourceId)`
  - 用户额外权限（实现映射）：
    - 不新增表，沿用直购课程表：`user_courses`
    - 将“直购课程”视为授予了 `RESOURCE_DOWNLOAD@COURSE={courseId}` 的用户额外权限
  - 用户课程授权：`src/main/java/org/xhy/community/domain/user/service/UserDomainService.java`
    - `grantCourseToUser(String userId, String courseId)` / `revokeCourseFromUserByOrder(String orderId)`（即授予/撤销额外权限）
  - 套餐与课程绑定：`src/main/java/org/xhy/community/domain/subscription/service/SubscriptionPlanDomainService.java`
  - 注意：Application → Domain Service；Domain Service → Repository；各层不越权。

- 基础设施（Infrastructure）
  - 类型转换器、Flyway 迁移、全局软删忽略（无需在查询中显式 `eq(deleted, false)`）。

## 4. 数据模型与迁移

复用现有数据模型：
- 用户直购课程表：`user_courses`（等价于用户额外权限 `RESOURCE_DOWNLOAD@COURSE` 的存储）。
- 套餐-课程绑定表：`subscription_plan_courses`（管理员配置）。
- 资源绑定表：`resource_bindings`（资源与课程/章节的多对多绑定）。

迁移：无新增表。若 `resource_bindings` 尚未创建，参考《课程资源绑定设计方案.md》的 Flyway 脚本命名与字段定义（PostgreSQL 语法，非高频字段不建索引）。

## 5. 访问流程（资源口鉴权）

时序（简化）：
1) PublicResourceController 收到 `/api/public/resource/{rid}/access` 请求，解析 `userId`；
2) 调用 `ResourceAppService.getResourceAccessUrl(resourceId, userId)`；
3) 读取资源绑定：若未绑定到任何课程/章节 → 直接放行（生成签名直链）；
4) 若存在绑定 → 聚合出 `courseIdSet`；
5) 并集判定（两条路径任一为真即通过）：
   - 套餐功能码路径：用户具备功能码 `RESOURCE_DOWNLOAD` 且 `courseIdSet` 与“用户有效套餐包含课程集”有交集；
   - 用户额外权限路径：用户具备任一 `RESOURCE_DOWNLOAD@COURSE` 且其 scope 命中 `courseIdSet`（实现上即 `hasUserCourse` 命中）。
6) 通过 → 返回签名直链；未通过 → 抛出业务异常或返回 403。

注意：
- 未绑定资源：仅当用户具备“全局下载能力”才放行（套餐含 `RESOURCE_DOWNLOAD` 或用户至少直购一门课程）；否则拒绝，防止免费用户刷带宽。
- 绑定资源：必须命中具体课程授权（直购该课程，或套餐包含该课程且具备 `RESOURCE_DOWNLOAD`）。
- 列表接口不做逐条资源判定，避免 N+1；仅在资源访问口做精确拦截。

## 6. 购买/退款联动（授权发放/撤销）

- 购买成功（或课程 CDK 激活）
  - App 层监听对应事件，在事务内调用：`UserDomainService.grantCourseToUser(userId, courseId)`，新增/幂等写入 `user_courses`；语义上等价于授予 `RESOURCE_DOWNLOAD@COURSE={courseId}`。
  - 资源访问无需额外授权表，直接依赖“课程解锁/额外权限并集”。

- 退款/撤销
  - App 层监听退款事件，调用：`UserDomainService.revokeCourseFromUserByOrder(orderId)` 撤销额外权限；
  - 若用户仍有其他路径（如套餐）解锁该课程，则资源访问仍允许。

## 7. 错误码与异常

- 统一位置：`src/main/java/org/xhy/community/infrastructure/exception`
- 课程/资源相关建议：
  - `CourseErrorCode.COURSE_ACCESS_DENIED`（已存在则复用）
  - `CourseErrorCode.RESOURCE_ACCESS_DENIED`（若无则新增，描述“无权限访问该资源”）
- 抛出规范：在 App 层统一抛出对应模块异常；Controller 不直接拼装业务规则。

## 8. 兼容与回填

- 未绑定资源：按现有逻辑放行，保证增量上线平滑；
- 历史章节内容：执行一次性回填任务，解析资源 ID 并建立 `resource_bindings` 绑定（详见《课程资源绑定设计方案.md》）；
- 已有直购用户：不需要额外迁移，`user_courses` 直接生效。

## 9. 校验与职责分工

- API层（Controller）：参数格式校验（@Valid/@NotBlank 等）与用户身份解析；
- Application层：编排流程、事务、DTO 转换；不做参数格式校验；
- Domain层：业务规则（课程解锁、授权发放/撤销、绑定关系查询等），不做格式校验；
- 调用关系遵循规范：Application → Domain Service；Domain Service → Repository；任何层可用 Infrastructure；禁止反向依赖。

## 10. 接入清单（代码改造点）

- 新增/确认存在：
  - `PublicResourceController` 中“资源下载功能码”校验改为并集判定：
    - 先取资源绑定到的 `courseIdSet`
    - 允许条件：`hasPlanPermission(userId, "RESOURCE_DOWNLOAD") && planIncludesAny(userId, courseIdSet)`
      或 `hasUserCourseAny(userId, courseIdSet)`
    - 推荐封装为 `userPermissionAppService.hasDownloadPermissionForResource(userId, resourceId)`
  - `ResourceAppService.getResourceAccessUrl(resourceId, userId)` 按第5节流程实现（无改动）
  - `ResourceBindingDomainService.getBoundCourseIdsByResource(resourceId)`；
  - `UserPermissionAppService.hasAccessToCourse(userId, courseId)`（保留，用于课程/章节接口）
  - 订单/激活监听中发放/撤销课程授权（已存在可复用）。

- 修改：
  - `PublicResourceController` 调用 `ResourceAppService`，将直链生成逻辑置于“解锁校验”之后；
  - 章节编辑流程在保存时触发资源绑定同步（详见关联文档）。

## 11. 测试用例

- 资源未绑定：任意登录用户按现状可访问（或遵循公共资源规则）。
- 资源绑定至收费课程的章节：
  - free 用户且未直购、套餐无功能码或不含该课程 → 403/RESOURCE_ACCESS_DENIED；
  - 用户直购该课程（拥有额外权限） → 200，返回签名直链；
  - 用户有效套餐包含该课程且套餐具备 `RESOURCE_DOWNLOAD` 功能码 → 200，返回签名直链；
  - 管理员 → 200，返回签名直链。
- 撤销直购授权后：若用户仍有套餐包含该课程 → 继续 200；否则 403。

## 12. 发布与回滚

- 发布步骤：
  - 执行 `resource_bindings` 相关迁移（若未存在）；
  - 发布后端（包含访问口与 App 层改造）；
  - 执行历史章节绑定回填任务（可灰度）；
  - 推送前端规范（资源链接统一走访问口）。
- 回滚策略：
  - 保留迁移的向后兼容；
  - 访问口可回退为“直链生成”旧逻辑（临时关闭绑定判定）。

## 13. FAQ

- Q：为何不新增 basic 套餐？
  - A：套餐负责“基线能力与配额”，直购负责“具体课程可用性”。将“曾购买过某课程”建模为套餐层级会使升级/降级/续费/退款变复杂，且难以覆盖课程包、活动等多样来源。额外授权（基于课程解锁）更解耦、可扩展。

- Q：free 用户怎么买后可看资源？
  - A：资源绑定到课程/章节；购买后具备该课程直购授权。资源访问口按“课程解锁”判定，通过后放行，即使套餐仍为 free。

- Q：是否需要新表存“资源授权”？
  - A：不需要。直接使用 `user_courses`（直购）与套餐-课程绑定的组合来判断“课程解锁”，资源仅作为“绑定到课程/章节”的从属对象。
