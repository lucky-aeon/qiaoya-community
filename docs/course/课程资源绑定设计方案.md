# 课程资源绑定设计方案

作者：后端
最后更新：2025-09-27
状态：设计稿（可实施）
适用范围：资源访问口、章节内容解析与绑定、按课程解锁联动

维护人：后端
关键代码路径：
- 接口层：src/main/java/org/xhy/community/interfaces/public_api/controller/PublicResourceController.java
- 应用层：src/main/java/org/xhy/community/application/resource/service/ResourceAppService.java
- 应用层：src/main/java/org/xhy/community/application/course/service/ChapterAppService.java
- 领域层：src/main/java/org/xhy/community/domain/resourcebinding/*

## 目录
- 0. 业务背景
- 1. 设计目标
- 2. 范围与非范围
- 3. 方案总览
- 4. 模块与文件路径
- 5. 数据模型与迁移
- 6. 访问流程（时序）
- 7. 章节内容解析与绑定同步
- 8. 兼容与回填
- 9. 性能与缓存
- 10. 风险与对策
- 11. 发布步骤与回滚
- 12. 验收清单

## 0. 业务背景

- 我们是付费社区场景：为适配不同营销方案，存在多个订阅套餐，不同套餐可访问课程范围不同；课程亦可单独购买促进转化。
- 目前资源访问仅基于通用权限校验（登录、黑名单、功能码等），未与“课程解锁（直购/套餐）”强关联，导致只要知道资源 ID 即可绕过课程权限访问章节内资源。
- 目标是在不改变前端链接形态的前提下，为资源增加“与课程/章节的绑定”，并在访问口做课程权限校验，保证资源与课程授权一致。

## 1. 设计目标

- 资源访问必须经过“课程解锁”校验（直购或有效套餐包含），未解锁直接拒绝。
- 兼容未绑定资源（如头像、公开图片等），保持现有访问体验。
- 绑定为通用模型，支持资源绑定到不同业务对象（章节/课程），可扩展到更多内容类型。
- 遵循 DDD 分层，不在 Controller 中堆业务逻辑，App 层编排、Domain 层持久化与规则。
- 性能友好：访问时常数次查询；章节编辑时同步绑定，支持幂等。

## 2. 范围与非范围

- 范围：资源与课程/章节绑定与访问控制联动；章节内容中的资源引用规范；历史数据回填方案。
- 非范围：CDN/OSS 存储策略调整；富文本/Markdown 编辑器前端实现细节；支付流程。

## 3. 方案总览

- 绑定模型：新增通用“资源绑定表”，记录资源与业务对象的多对多关系（支持 CHAPTER、COURSE）。
- 绑定时机：在“创建/编辑章节”时，解析章节内容中所有资源链接，按章节 ID 全量同步绑定关系。
- 访问校验：资源访问入口在生成签名直链前读取绑定关系，若绑定到课程/章节则执行课程解锁校验（直购/套餐）。
- 链接规范：章节内资源统一通过受控访问口引用（/api/public/resource/{id}/access），禁止直链 OSS；未按规范引用的资源无法被绑定与控制。
- 兼容策略：未绑定资源按现有逻辑继续访问，保证增量上线的平滑性；提供历史回填工具将存量章节内容建立绑定。

## 4. 模块与文件路径

- 接口层（Interfaces）
  - 资源访问：`src/main/java/org/xhy/community/interfaces/public_api/controller/PublicResourceController.java`
    - 行为：解析 Cookie/Authorization，完成通用校验后，调用 App 层按“绑定+解锁”生成访问直链；未通过返回 403。
  - 资源上传凭证与访问会话：`src/main/java/org/xhy/community/interfaces/resource/controller/ResourceController.java`（保持现状）。

- 应用层（Application）
  - 资源访问编排：`src/main/java/org/xhy/community/application/resource/service/ResourceAppService.java`
    - 新签名：`getResourceAccessUrl(resourceId, userId)`（App 层不直接读取 UserContext）。
    - 流程：读取绑定 → 若为空放行 → 若有绑定，聚合出相关课程 ID → 调“课程解锁”判定 → 通过则生成签名 URL。
  - 章节编排：`src/main/java/org/xhy/community/application/course/service/ChapterAppService.java`
    - 在创建/更新章节时解析内容中的资源链接，调用绑定领域服务进行“先删后插”或差异同步。

- 领域层（Domain）
  - 资源绑定子域（新增）：`src/main/java/org/xhy/community/domain/resourcebinding/*`
    - Entity：`ResourceBindingEntity`（resourceId、targetType、targetId、通用基类字段）。
    - Repository：`ResourceBindingRepository extends BaseMapper<ResourceBindingEntity>`。
    - Service：`ResourceBindingDomainService`，能力：
      - `syncBindingsForChapter(chapterId, resourceIds)`：按章节全量同步绑定。
      - `getBindingsByResource(resourceId)` / `getBoundCourseIdsByResource(resourceId)`：访问校验用。
    - ValueObject（可选）：`ResourceTargetType`（CHAPTER、COURSE），并在 `MyBatisTypeHandlerConfig` 中注册类型处理器。
  - 课程授权复用：
    - 直购判定：`UserDomainService.hasUserCourse(userId, courseId)`。
    - 套餐判定：`SubscriptionDomainService.getUserActiveSubscriptions(userId)` → `SubscriptionPlanDomainService.getCourseIdsByPlanIds(planIds)`（批量查询，避免循环）。

## 5. 数据模型与迁移

- 迁移位置：`src/main/resources/db/migration`
- 迁移文件：`VXX__Create_resource_bindings_table.sql`
- 字段说明：
  - id：UUID，主键；
  - resource_id：资源 ID；
  - target_type：绑定类型（CHAPTER/COURSE 等）；
  - target_id：业务对象 ID（章节 ID 或课程 ID）；
  - create_time、update_time、deleted：遵循通用基类；
  - 索引：`(resource_id, target_type, target_id)` 唯一（deleted=false），并为 `resource_id`、`(target_type, target_id)` 建常用索引。

## 6. 访问流程（时序）

- 前端元素请求 `/api/public/resource/{rid}/access`（Cookie: RAUTH 或 Header: Bearer）。
- PublicResourceController 读取并校验 token → 解析 userId → 调 `ResourceAppService.getResourceAccessUrl(resourceId, userId)`。
- ResourceAppService：
  - 读取绑定：若未绑定，直接生成签名直链放行；
  - 若绑定到 CHAPTER：查询章节归属课程 ID；若绑定到 COURSE：直接得到课程 ID；如绑定多个，聚合；
  - 判定用户是否解锁任一课程（直购/有效套餐包含）；
  - 通过 → 返回签名直链；不通过 → 403。

## 7. 章节内容解析与绑定同步

- 引用规范：章节内容必须通过受控访问链接引用资源（/api/public/resource/{id}/access），禁止使用直链 OSS。
- 解析策略：在 ChapterAppService 的创建/更新流程中，以正则匹配上述链接模式提取 resourceId 集合。
- 同步策略：`syncBindingsForChapter` 采用全量同步（对比/先删后插），保证幂等；当章节迁移、内容修改时，绑定关系随之更新。

## 8. 兼容与回填

- 上线后对新/变更章节生效；
- 历史章节回填：提供一次性任务读取所有章节内容，解析资源 ID 并批量建立绑定；
- 未绑定资源：保持现有访问行为，避免大面积回滚风险。

## 9. 性能与缓存

- 访问时查询：`resourceId → 绑定列表` 与 `planIds → courseIds` 为常见读路径，满足毫秒级；
- 可在 `ResourceBindingDomainService` 引入本地/分布式缓存（resourceId → courseIdSet）以降低高频资源的绑定查询开销；
- 章节更新后主动失效对应 resourceId 的缓存键。

## 10. 风险与对策

- 前端仍使用直链 OSS：无法纳入访问控制。对策：统一替换为访问口链接，并在发布/CI 工具中执行扫描；
- 内容格式多样（Markdown/HTML）：需覆盖常见标签/语法的链接提取；
- 绑定漂移（资源引用删除/章节删除）：采用全量同步并在删除时清理；
- 共享设备或 Cookie 泄露：RAUTH Cookie 时效短（例如 15 分钟），并支持黑名单失效；
- 多重绑定：任一绑定的课程解锁即放行，避免误拦截；
- 高并发热资源：结合缓存与限流；

## 11. 发布步骤与回滚

- 步骤：
  - 执行数据库迁移（Flyway）。
  - 发布后端：包含新领域模型、App 编排与 Public 控制器调用改造。
  - 执行历史章节回填任务（可灰度）。
  - 推送前端规范：统一替换章节内资源引用为访问口链接。
- 回滚：迁移保持向后兼容；若需回滚逻辑，只需恢复 PublicResourceController 访问直链路径的旧实现。

## 12. 验收清单

- 未绑定资源可正常访问；
- 绑定至收费课程章节的资源：
  - 无直购且套餐不含 → 返回 403；
  - 直购 → 返回 302 跳转签名直链；
  - 套餐包含 → 返回 302 跳转签名直链；
- 同一资源绑定多个章节/课程时，任一课程解锁即可访问；
- 章节更新后绑定关系同步生效；
- 高并发下访问成功率与耗时符合预期。
