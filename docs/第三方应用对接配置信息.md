# æ•²é¸­ç¤¾åŒº SSO å•ç‚¹ç™»å½•å¯¹æ¥æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [æ¥å…¥å‰å‡†å¤‡](#æ¥å…¥å‰å‡†å¤‡)
- [æˆæƒæµç¨‹](#æˆæƒæµç¨‹)
- [æ¥å£è§„èŒƒ](#æ¥å£è§„èŒƒ)
- [æ¥å£è¯¦æƒ…](#æ¥å£è¯¦æƒ…)
- [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
- [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ¦‚è¿°

æ•²é¸­ç¤¾åŒºæä¾›åŸºäº **OAuth 2.0 + OpenID Connect (OIDC)** æ ‡å‡†çš„å•ç‚¹ç™»å½•æœåŠ¡ï¼Œæ”¯æŒç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡æ ‡å‡†åè®®æ¥å…¥ç”¨æˆ·è®¤è¯ä¸æˆæƒåŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… åŸºäº OAuth 2.0 æˆæƒç æ¨¡å¼ï¼ˆAuthorization Code Flowï¼‰
- âœ… æ”¯æŒ PKCE å®‰å…¨å¢å¼ºï¼ˆæ¨èï¼‰
- âœ… ç¬¦åˆ OpenID Connect è§„èŒƒ
- âœ… æä¾›ç”¨æˆ·åŸºæœ¬ä¿¡æ¯æ¥å£
- âœ… æ”¯æŒ Refresh Token åˆ·æ–°è®¿é—®ä»¤ç‰Œ

### æŠ€æœ¯è¦æ±‚

- HTTP/HTTPS åè®®
- JSON æ•°æ®æ ¼å¼
- å‚æ•°å‘½åï¼š**é©¼å³°å‘½åï¼ˆcamelCaseï¼‰**

---

## æ¥å…¥å‰å‡†å¤‡

åœ¨å¼€å§‹å¯¹æ¥ SSO ä¹‹å‰ï¼Œæ‚¨éœ€è¦å‘æ•²é¸­ç¤¾åŒºç®¡ç†å‘˜ç”³è¯·ä»¥ä¸‹ä¿¡æ¯ï¼š

### å¿…éœ€å‚æ•°æ¸…å•

| å‚æ•°å | è¯´æ˜ | ç¤ºä¾‹ | è·å–æ–¹å¼ |
|--------|------|------|---------|
| **Client ID** | å®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†ç¬¦ | `demo` | å‘ç®¡ç†å‘˜ç”³è¯· |
| **Client Secret** | å®¢æˆ·ç«¯å¯†é’¥ï¼ˆéœ€å¦¥å–„ä¿ç®¡ï¼‰ | `02d6e1cf7f20408db24...` | å‘ç®¡ç†å‘˜ç”³è¯· |
| **Redirect URI** | æˆæƒå›è°ƒåœ°å€ï¼ˆéœ€é¢„å…ˆæ³¨å†Œï¼‰ | `http://your-app.com/callback` | å‘ç®¡ç†å‘˜æä¾›å¹¶æ³¨å†Œ |
| **SSO æœåŠ¡å™¨åœ°å€** | SSO æœåŠ¡çš„åŸºç¡€ URL | `http://localhost:8520` | ç®¡ç†å‘˜æä¾› |

### ç”³è¯·æµç¨‹

#### ç¬¬ 1 æ­¥ï¼šå‡†å¤‡åº”ç”¨ä¿¡æ¯

å‘ç®¡ç†å‘˜æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

```
åº”ç”¨åç§°: æ‚¨çš„åº”ç”¨åç§°
åº”ç”¨æè¿°: ç®€è¦è¯´æ˜åº”ç”¨ç”¨é€”
åº”ç”¨ç±»å‹: Web åº”ç”¨ / ç§»åŠ¨åº”ç”¨ / æœåŠ¡ç«¯åº”ç”¨
å›è°ƒåœ°å€: http://your-app.com/callback (å¯æä¾›å¤šä¸ª)
æ‰€éœ€æƒé™: openid profile email (æˆ–å…¶ä»–éœ€è¦çš„ scopes)
```

#### ç¬¬ 2 æ­¥ï¼šè·å–å‡­è¯

ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡åï¼Œä¼šæä¾›ç»™æ‚¨ï¼š

```json
{
  "clientId": "your-client-id",
  "clientSecret": "your-client-secret-keep-it-safe",
  "redirectUris": [
    "http://your-app.com/callback",
    "http://localhost:3000/callback"  // å¼€å‘ç¯å¢ƒ
  ],
  "scopes": ["openid", "profile", "email"]
}
```

#### ç¬¬ 3 æ­¥ï¼šé…ç½®ç«¯ç‚¹åœ°å€

æ ¹æ®ç®¡ç†å‘˜æä¾›çš„ SSO æœåŠ¡å™¨åœ°å€ï¼Œé…ç½®ä»¥ä¸‹ç«¯ç‚¹ï¼š

```javascript
const SSO_CONFIG = {
  baseUrl: 'http://localhost:8520',  // æ›¿æ¢ä¸ºå®é™…åœ°å€
  authorizeEndpoint: '/api/public/oauth2/authorize',
  tokenEndpoint: '/api/public/oauth2/token',
  userInfoEndpoint: '/api/user'
};
```

### âš ï¸ å®‰å…¨æé†’

1. **å¦¥å–„ä¿ç®¡ Client Secret**
    - âŒ ä¸è¦å°† Client Secret ç¡¬ç¼–ç åœ¨å‰ç«¯ä»£ç ä¸­
    - âœ… åº”å­˜å‚¨åœ¨åç«¯æœåŠ¡å™¨çš„ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ä¸­
    - âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¸“ç”¨çš„å¯†é’¥ç®¡ç†æœåŠ¡

2. **å›è°ƒåœ°å€éªŒè¯**
    - SSO æœåŠ¡å™¨ä¼šä¸¥æ ¼éªŒè¯ `redirectUri` æ˜¯å¦ä¸æ³¨å†Œçš„åœ°å€ä¸€è‡´
    - å¦‚éœ€æ·»åŠ æ–°çš„å›è°ƒåœ°å€ï¼Œè¯·è”ç³»ç®¡ç†å‘˜é‡æ–°é…ç½®

3. **ä½¿ç”¨ HTTPS**
    - ç”Ÿäº§ç¯å¢ƒ**å¿…é¡»**ä½¿ç”¨ HTTPS åè®®
    - å¼€å‘ç¯å¢ƒå¯ä»¥ä½¿ç”¨ HTTPï¼ˆlocalhostï¼‰

### å‡†å¤‡å·¥ä½œæ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹ç¼–ç ä¹‹å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] å·²è·å¾— `clientId` å’Œ `clientSecret`
- [ ] å·²åœ¨ SSO æœåŠ¡å™¨æ³¨å†Œ `redirectUri`
- [ ] å·²çŸ¥æ™“ SSO æœåŠ¡å™¨åœ°å€
- [ ] å·²äº†è§£æ‰€éœ€çš„æƒé™èŒƒå›´ï¼ˆscopesï¼‰
- [ ] å·²é…ç½®å¥½å¼€å‘ç¯å¢ƒï¼ˆæ”¯æŒ HTTPS æˆ– localhostï¼‰

---

## æˆæƒæµç¨‹

### æ ‡å‡† OAuth 2.0 æˆæƒç æµç¨‹ï¼ˆæ¨èä½¿ç”¨ PKCEï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚                                  â”‚             â”‚
â”‚  ç¬¬ä¸‰æ–¹åº”ç”¨  â”‚                                  â”‚  SSO æœåŠ¡å™¨  â”‚
â”‚             â”‚                                  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                â”‚
       â”‚ 1. è·³è½¬æˆæƒé¡µé¢ (å¸¦ code_challenge)            â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                â”‚
       â”‚                                                â”‚ 2. ç”¨æˆ·ç™»å½•å¹¶æˆæƒ
       â”‚                                                â”‚
       â”‚ 3. è¿”å›æˆæƒç  (code)                           â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                                â”‚
       â”‚ 4. ç”¨æˆæƒç æ¢å– Token (å¸¦ code_verifier)        â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                â”‚
       â”‚ 5. è¿”å› Access Token                           â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                                â”‚
       â”‚ 6. ä½¿ç”¨ Token è·å–ç”¨æˆ·ä¿¡æ¯                      â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                â”‚
       â”‚ 7. è¿”å›ç”¨æˆ·è¯¦ç»†ä¿¡æ¯                            â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                                â”‚
```

### æµç¨‹æ­¥éª¤è¯´æ˜

1. **ç”Ÿæˆ PKCE å‚æ•°**ï¼ˆå®¢æˆ·ç«¯ï¼‰
    - ç”Ÿæˆéšæœº `code_verifier`ï¼ˆ128 å­—ç¬¦ï¼‰
    - è®¡ç®— `code_challenge = BASE64URL(SHA256(code_verifier))`
    - ç”Ÿæˆéšæœº `state`ï¼ˆé˜² CSRFï¼‰

2. **è·³è½¬æˆæƒé¡µé¢**
    - æ„å»ºæˆæƒ URL å¹¶è·³è½¬åˆ° SSO æˆæƒç«¯ç‚¹

3. **ç”¨æˆ·æˆæƒ**ï¼ˆSSO æœåŠ¡å™¨ï¼‰
    - ç”¨æˆ·åœ¨ SSO é¡µé¢ç™»å½•
    - ç”¨æˆ·åŒæ„æˆæƒ

4. **è·å–æˆæƒç **
    - SSO é‡å®šå‘å›ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œæºå¸¦ `code` å’Œ `state`

5. **äº¤æ¢ Access Token**
    - ä½¿ç”¨ `code` å’Œ `code_verifier` æ¢å– `accessToken`

6. **è·å–ç”¨æˆ·ä¿¡æ¯**
    - ä½¿ç”¨ `accessToken` è°ƒç”¨ç”¨æˆ·ä¿¡æ¯æ¥å£

---

## æ¥å£è§„èŒƒ

### åŸºç¡€ä¿¡æ¯

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **åè®®** | HTTP/HTTPS |
| **æ•°æ®æ ¼å¼** | JSON |
| **å­—ç¬¦ç¼–ç ** | UTF-8 |
| **å‚æ•°å‘½å** | é©¼å³°å‘½åï¼ˆcamelCaseï¼‰ |
| **Base URL** | `http://localhost:8520` (ç”Ÿäº§ç¯å¢ƒè¯·æ›¿æ¢) |

### ç«¯ç‚¹åˆ—è¡¨

| ç«¯ç‚¹åç§° | æ–¹æ³• | è·¯å¾„ |
|---------|------|------|
| æˆæƒç«¯ç‚¹ | GET | `/api/public/oauth2/authorize` |
| ä»¤ç‰Œç«¯ç‚¹ | POST | `/api/public/oauth2/token` |
| ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹ | GET | `/api/user` |
| å®¢æˆ·ç«¯ä¿¡æ¯ç«¯ç‚¹ | GET | `/api/public/oauth2/clients/{clientId}` |

### ç»Ÿä¸€å“åº”æ ¼å¼

æ‰€æœ‰æ¥å£è¿”å›ç»Ÿä¸€çš„ `ApiResponse` æ ¼å¼ï¼š

```json
{
  "code": 200,
  "message": "æˆåŠŸ",
  "data": {
    // å®é™…æ•°æ®
  }
}
```

---

## æ¥å£è¯¦æƒ…

### 1. æˆæƒç«¯ç‚¹

**ç”¨é€”**: ç¬¬ä¸‰æ–¹åº”ç”¨è·³è½¬åˆ°æ­¤ç«¯ç‚¹è¯·æ±‚ç”¨æˆ·æˆæƒ

#### è¯·æ±‚ä¿¡æ¯

```http
GET /api/public/oauth2/authorize?{params}
```

#### è¯·æ±‚å‚æ•°ï¼ˆURL Queryï¼‰

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| `responseType` | String | âœ… | å›ºå®šå€¼ï¼š`code` |
| `clientId` | String | âœ… | å®¢æˆ·ç«¯ IDï¼ˆéœ€å‘ç®¡ç†å‘˜ç”³è¯·ï¼‰ |
| `redirectUri` | String | âœ… | æˆæƒå›è°ƒåœ°å€ï¼ˆéœ€é¢„å…ˆæ³¨å†Œï¼‰ |
| `scope` | String | âŒ | æƒé™èŒƒå›´ï¼Œç©ºæ ¼åˆ†éš”ã€‚å¦‚ï¼š`openid profile email` |
| `state` | String | âœ… | éšæœºå­—ç¬¦ä¸²ï¼Œç”¨äºé˜² CSRF æ”»å‡» |
| `codeChallenge` | String | âœ… | PKCE code challengeï¼ˆæ¨èï¼‰ |
| `codeChallengeMethod` | String | âœ… | å›ºå®šå€¼ï¼š`S256` |

#### ç¤ºä¾‹è¯·æ±‚

```javascript
// 1. ç”Ÿæˆ PKCE å‚æ•°
const codeVerifier = generateRandomString(128);
const codeChallenge = await sha256(codeVerifier);
const state = generateRandomString(32);

// 2. ä¿å­˜åˆ° sessionStorage
sessionStorage.setItem('code_verifier', codeVerifier);
sessionStorage.setItem('oauth_state', state);

// 3. æ„å»ºæˆæƒ URL
const params = new URLSearchParams({
    responseType: 'code',
    clientId: 'your-client-id',
    redirectUri: 'http://your-app.com/callback',
    scope: 'openid profile email',
    state: state,
    codeChallenge: codeChallenge,
    codeChallengeMethod: 'S256'
});

const authorizeUrl = `http://localhost:8520/api/public/oauth2/authorize?${params}`;

// 4. è·³è½¬
window.location.href = authorizeUrl;
```

#### å“åº”è¯´æ˜

ç”¨æˆ·æˆæƒåï¼ŒSSO ä¼šé‡å®šå‘åˆ° `redirectUri`ï¼Œæºå¸¦ä»¥ä¸‹å‚æ•°ï¼š

**æˆåŠŸå“åº”**:
```
http://your-app.com/callback?code=AUTHORIZATION_CODE&state=YOUR_STATE
```

**å¤±è´¥å“åº”**:
```
http://your-app.com/callback?error=access_denied&error_description=ç”¨æˆ·æ‹’ç»æˆæƒ
```

---

### 2. ä»¤ç‰Œç«¯ç‚¹

**ç”¨é€”**: ä½¿ç”¨æˆæƒç æ¢å– Access Token

#### è¯·æ±‚ä¿¡æ¯

```http
POST /api/public/oauth2/token
Content-Type: application/json
```

#### è¯·æ±‚å‚æ•°ï¼ˆJSON Bodyï¼‰

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| `grantType` | String | âœ… | æˆæƒç±»å‹ã€‚æˆæƒç æ¨¡å¼ï¼š`authorization_code`<br>åˆ·æ–°ä»¤ç‰Œæ¨¡å¼ï¼š`refresh_token` |
| `clientId` | String | âœ… | å®¢æˆ·ç«¯ ID |
| `clientSecret` | String | âœ… | å®¢æˆ·ç«¯å¯†é’¥ |
| `code` | String | âœ…* | æˆæƒç ï¼ˆæˆæƒç æ¨¡å¼å¿…å¡«ï¼‰ |
| `redirectUri` | String | âœ…* | å›è°ƒåœ°å€ï¼ˆæˆæƒç æ¨¡å¼å¿…å¡«ï¼Œéœ€ä¸æˆæƒæ—¶ä¸€è‡´ï¼‰ |
| `codeVerifier` | String | âœ…* | PKCE code verifierï¼ˆæˆæƒç æ¨¡å¼å¿…å¡«ï¼‰ |
| `refreshToken` | String | âœ…* | åˆ·æ–°ä»¤ç‰Œï¼ˆåˆ·æ–°ä»¤ç‰Œæ¨¡å¼å¿…å¡«ï¼‰ |

**\* æ ¹æ® `grantType` ä¸åŒï¼Œå¿…å¡«å‚æ•°ä¸åŒ**

#### ç¤ºä¾‹è¯·æ±‚ï¼ˆæˆæƒç æ¨¡å¼ï¼‰

```javascript
const tokenResponse = await fetch('http://localhost:8520/api/public/oauth2/token', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({
        grantType: 'authorization_code',
        clientId: 'your-client-id',
        clientSecret: 'your-client-secret',
        code: 'AUTHORIZATION_CODE',
        redirectUri: 'http://your-app.com/callback',
        codeVerifier: codeVerifier  // ä» sessionStorage è·å–
    })
});

const response = await tokenResponse.json();
```

#### å“åº”ç¤ºä¾‹

```json
{
  "code": 200,
  "message": "",
  "data": {
    "accessToken": "eyJhbGciOiJIUzM4NCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 86399,
    "refreshToken": "3I2JxEo7aBVVUYpXV3TX...",
    "scope": "openid profile email"
  }
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `accessToken` | String | è®¿é—®ä»¤ç‰Œï¼Œç”¨äºè°ƒç”¨å—ä¿æŠ¤çš„ API |
| `tokenType` | String | ä»¤ç‰Œç±»å‹ï¼Œå›ºå®šä¸º `Bearer` |
| `expiresIn` | Integer | è®¿é—®ä»¤ç‰Œè¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ |
| `refreshToken` | String | åˆ·æ–°ä»¤ç‰Œï¼Œç”¨äºè·å–æ–°çš„è®¿é—®ä»¤ç‰Œ |
| `scope` | String | æˆæƒçš„æƒé™èŒƒå›´ |

---

### 3. ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹

**ç”¨é€”**: è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯

#### è¯·æ±‚ä¿¡æ¯

```http
GET /api/user
Authorization: Bearer {accessToken}
```

#### è¯·æ±‚å¤´

| å‚æ•°å | å€¼ | è¯´æ˜ |
|--------|------|------|
| `Authorization` | `Bearer {accessToken}` | å¿…å¡«ï¼Œè®¿é—®ä»¤ç‰Œ |

#### ç¤ºä¾‹è¯·æ±‚

```javascript
const userInfoResponse = await fetch('http://localhost:8520/api/user', {
    headers: {
        'Authorization': `Bearer ${accessToken}`
    }
});

const response = await userInfoResponse.json();
```

#### å“åº”ç¤ºä¾‹

```json
{
  "code": 200,
  "message": "",
  "data": {
    "id": "13",
    "name": "xhy",
    "email": "xhyovo@qq.com",
    "description": "ç¤¾åŒºç®¡ç†å‘˜",
    "avatar": "589",
    "status": "ACTIVE",
    "role": "ADMIN",
    "tags": ["ç¤¾åŒºè¿è¥è€…"],
    "emailNotificationEnabled": true,
    "maxConcurrentDevices": 2,
    "currentSubscriptionPlanId": "e184abe9bb836471ffcd1c52e8d19bdf",
    "currentSubscriptionPlanName": "plus",
    "currentSubscriptionLevel": 2,
    "currentSubscriptionStartTime": "2025-09-28 23:12:07",
    "currentSubscriptionEndTime": "2026-09-28 23:12:07",
    "createTime": "2024-03-26 07:14:12",
    "updateTime": "2025-09-30 16:54:11"
  }
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `id` | String | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| `name` | String | ç”¨æˆ·å |
| `email` | String | é‚®ç®±åœ°å€ |
| `description` | String | ä¸ªäººç®€ä»‹ |
| `avatar` | String | å¤´åƒ ID |
| `status` | String | ç”¨æˆ·çŠ¶æ€ï¼š`ACTIVE`(æ´»è·ƒ)ã€`INACTIVE`(ä¸æ´»è·ƒ)ã€`SUSPENDED`(æš‚åœ)ã€`BANNED`(å°ç¦) |
| `role` | String | ç”¨æˆ·è§’è‰²ï¼š`USER`(æ™®é€šç”¨æˆ·)ã€`ADMIN`(ç®¡ç†å‘˜)ã€`MODERATOR`(ç‰ˆä¸») |
| `tags` | Array | ç”¨æˆ·æ ‡ç­¾åˆ—è¡¨ |
| `emailNotificationEnabled` | Boolean | æ˜¯å¦å¼€å¯é‚®ä»¶é€šçŸ¥ |
| `currentSubscriptionPlanName` | String | å½“å‰è®¢é˜…è®¡åˆ’åç§° |
| `currentSubscriptionLevel` | Integer | è®¢é˜…ç­‰çº§ |

---

### 4. åˆ·æ–°ä»¤ç‰Œ

å½“ `accessToken` è¿‡æœŸåï¼Œå¯ä½¿ç”¨ `refreshToken` è·å–æ–°çš„è®¿é—®ä»¤ç‰Œã€‚

#### ç¤ºä¾‹è¯·æ±‚

```javascript
const tokenResponse = await fetch('http://localhost:8520/api/public/oauth2/token', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({
        grantType: 'refresh_token',
        clientId: 'your-client-id',
        clientSecret: 'your-client-secret',
        refreshToken: 'YOUR_REFRESH_TOKEN'
    })
});
```

---

## ä»£ç ç¤ºä¾‹

### å®Œæ•´çš„å‰ç«¯é›†æˆç¤ºä¾‹ï¼ˆJavaScriptï¼‰

```javascript
// OAuth2 é…ç½®
const CONFIG = {
    clientId: 'demo',
    clientSecret: 'your-client-secret',
    authorizeEndpoint: 'http://localhost:8520/api/public/oauth2/authorize',
    tokenEndpoint: 'http://localhost:8520/api/public/oauth2/token',
    userInfoEndpoint: 'http://localhost:8520/api/user',
    redirectUri: 'http://localhost:5174/oauth/callback',
    scope: 'openid profile email'
};

// ========== å·¥å…·å‡½æ•° ==========

// ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
function generateRandomString(length) {
    const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
    let result = '';
    const randomValues = new Uint8Array(length);
    crypto.getRandomValues(randomValues);
    for (let i = 0; i < length; i++) {
        result += charset[randomValues[i] % charset.length];
    }
    return result;
}

// Base64 URL ç¼–ç 
function base64UrlEncode(arrayBuffer) {
    const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

// ç”Ÿæˆ PKCE code_challenge
async function generateCodeChallenge(codeVerifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(codeVerifier);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return base64UrlEncode(hash);
}

// ========== æ­¥éª¤ 1: å‘èµ·æˆæƒè¯·æ±‚ ==========

async function login() {
    // ç”Ÿæˆ PKCE å‚æ•°
    const state = generateRandomString(32);
    const codeVerifier = generateRandomString(128);
    const codeChallenge = await generateCodeChallenge(codeVerifier);

    // ä¿å­˜åˆ° sessionStorage
    sessionStorage.setItem('oauth_state', state);
    sessionStorage.setItem('code_verifier', codeVerifier);

    // æ„å»ºæˆæƒ URL
    const params = new URLSearchParams({
        responseType: 'code',
        clientId: CONFIG.clientId,
        redirectUri: CONFIG.redirectUri,
        scope: CONFIG.scope,
        state: state,
        codeChallenge: codeChallenge,
        codeChallengeMethod: 'S256'
    });

    // è·³è½¬åˆ°æˆæƒé¡µé¢
    window.location.href = `${CONFIG.authorizeEndpoint}?${params}`;
}

// ========== æ­¥éª¤ 2: å¤„ç†æˆæƒå›è°ƒ ==========

async function handleCallback() {
    // è§£æ URL å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');

    // éªŒè¯ state
    const savedState = sessionStorage.getItem('oauth_state');
    if (state !== savedState) {
        throw new Error('State éªŒè¯å¤±è´¥');
    }

    // è·å– code_verifier
    const codeVerifier = sessionStorage.getItem('code_verifier');

    // äº¤æ¢ Token
    const tokenResponse = await fetch(CONFIG.tokenEndpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            grantType: 'authorization_code',
            code: code,
            redirectUri: CONFIG.redirectUri,
            clientId: CONFIG.clientId,
            clientSecret: CONFIG.clientSecret,
            codeVerifier: codeVerifier
        })
    });

    const response = await tokenResponse.json();

    if (response.code !== 200) {
        throw new Error(response.message || 'è·å– Token å¤±è´¥');
    }

    const tokenData = response.data;

    // ä¿å­˜ Token
    sessionStorage.setItem('access_token', tokenData.accessToken);
    sessionStorage.setItem('refresh_token', tokenData.refreshToken);

    // è·å–ç”¨æˆ·ä¿¡æ¯
    const userInfoResponse = await fetch(CONFIG.userInfoEndpoint, {
        headers: {
            'Authorization': `Bearer ${tokenData.accessToken}`
        }
    });

    const userInfoData = await userInfoResponse.json();
    const userInfo = userInfoData.code === 200 ? userInfoData.data : userInfoData;

    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
    sessionStorage.setItem('user_info', JSON.stringify(userInfo));

    // æ¸…ç†ä¸´æ—¶æ•°æ®
    sessionStorage.removeItem('oauth_state');
    sessionStorage.removeItem('code_verifier');

    // è·³è½¬åˆ°åº”ç”¨é¦–é¡µ
    window.location.href = '/';
}
```

---

## é”™è¯¯å¤„ç†

### é”™è¯¯å“åº”æ ¼å¼

```json
{
  "code": 400,
  "message": "client_idä¸èƒ½ä¸ºç©º",
  "data": null
}
```

### å¸¸è§é”™è¯¯ç 

| HTTP çŠ¶æ€ç  | code | message | è¯´æ˜ |
|------------|------|---------|------|
| 400 | 400 | `client_idä¸èƒ½ä¸ºç©º` | ç¼ºå°‘å¿…å¡«å‚æ•° |
| 400 | 400 | `redirect_uriä¸èƒ½ä¸ºç©º` | ç¼ºå°‘å›è°ƒåœ°å€ |
| 400 | 400 | `æ— æ•ˆçš„å®¢æˆ·ç«¯` | Client ID ä¸å­˜åœ¨ |
| 400 | 400 | `æ— æ•ˆçš„é‡å®šå‘URI` | å›è°ƒåœ°å€æœªæ³¨å†Œ |
| 400 | 400 | `æˆæƒç å·²è¿‡æœŸ` | æˆæƒç è¶…æ—¶ï¼ˆé€šå¸¸ 5 åˆ†é’Ÿï¼‰ |
| 400 | 400 | `æ— æ•ˆçš„æˆæƒç ` | æˆæƒç ä¸å­˜åœ¨æˆ–å·²ä½¿ç”¨ |
| 401 | 401 | `æœªæˆæƒ` | Token æ— æ•ˆæˆ–è¿‡æœŸ |
| 403 | 403 | `ç”¨æˆ·æ‹’ç»æˆæƒ` | ç”¨æˆ·åœ¨æˆæƒé¡µé¢ç‚¹å‡»æ‹’ç» |

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•ç”³è¯· Client ID å’Œ Client Secretï¼Ÿ

è¯·å‚è€ƒæ–‡æ¡£å¼€å¤´çš„ [**æ¥å…¥å‰å‡†å¤‡**](#æ¥å…¥å‰å‡†å¤‡) ç« èŠ‚ï¼Œå…¶ä¸­è¯¦ç»†è¯´æ˜äº†ç”³è¯·æµç¨‹å’Œæ‰€éœ€ä¿¡æ¯ã€‚

ç®€è¦æ­¥éª¤ï¼š
1. å‡†å¤‡åº”ç”¨ä¿¡æ¯ï¼ˆåº”ç”¨åç§°ã€æè¿°ã€å›è°ƒåœ°å€ç­‰ï¼‰
2. è”ç³»ç®¡ç†å‘˜ï¼ˆxhyovo@qq.comï¼‰æäº¤ç”³è¯·
3. è·å– `clientId` å’Œ `clientSecret` å‡­è¯
4. é…ç½®ç«¯ç‚¹åœ°å€å¹¶å¼€å§‹å¼€å‘

### Q2: ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ PKCEï¼Ÿ

PKCEï¼ˆProof Key for Code Exchangeï¼‰æ˜¯ OAuth 2.0 çš„å®‰å…¨å¢å¼ºæœºåˆ¶ï¼Œå¯ä»¥é˜²æ­¢æˆæƒç æ‹¦æˆªæ”»å‡»ã€‚å¯¹äºå‰ç«¯åº”ç”¨ï¼ˆæ— æ³•å®‰å…¨å­˜å‚¨ Client Secretï¼‰ï¼Œå¼ºçƒˆæ¨èä½¿ç”¨ PKCEã€‚

### Q3: accessToken çš„æœ‰æ•ˆæœŸæ˜¯å¤šä¹…ï¼Ÿ

é»˜è®¤ 24 å°æ—¶ï¼ˆ86400 ç§’ï¼‰ã€‚è¿‡æœŸåå¯ä½¿ç”¨ `refreshToken` è·å–æ–°çš„ `accessToken`ã€‚

### Q4: å‚æ•°å‘½åä¸ºä»€ä¹ˆä½¿ç”¨é©¼å³°ï¼Ÿ

æœ¬ç³»ç»Ÿåç«¯ä½¿ç”¨ Java + Spring Boot å¼€å‘ï¼Œé»˜è®¤ä½¿ç”¨é©¼å³°å‘½åè§„èŒƒã€‚æ‰€æœ‰è¯·æ±‚å‚æ•°å’Œå“åº”å­—æ®µå‡ä½¿ç”¨é©¼å³°å‘½åï¼ˆå¦‚ `clientId`ã€`accessToken`ï¼‰ã€‚

### Q5: å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Ÿ

å°†æ–‡æ¡£ä¸­çš„ `http://localhost:8520` æ›¿æ¢ä¸ºç”Ÿäº§ç¯å¢ƒçš„å®é™…åŸŸåï¼Œå¹¶ç¡®ä¿ï¼š
- ä½¿ç”¨ HTTPS åè®®
- æ­£ç¡®é…ç½® CORSï¼ˆå¦‚æœå‰ç«¯ä¸åç«¯åŸŸåä¸åŒï¼‰
- å¦¥å–„ä¿ç®¡ Client Secretï¼ˆå»ºè®®åœ¨åç«¯æœåŠ¡å™¨ä¸­ä½¿ç”¨ï¼‰

### Q6: æ”¯æŒå“ªäº›æƒé™èŒƒå›´ï¼ˆScopesï¼‰ï¼Ÿ

å½“å‰æ”¯æŒçš„æ ‡å‡† Scopesï¼š
- `openid` - å¿…å¡«ï¼Œè¡¨ç¤ºä½¿ç”¨ OpenID Connect
- `profile` - è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆç”¨æˆ·åã€ç®€ä»‹ç­‰ï¼‰
- `email` - è·å–ç”¨æˆ·é‚®ç®±

### Q7: Token å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

æ¨èå­˜å‚¨æ–¹å¼ï¼š
- å‰ç«¯åº”ç”¨ï¼š`sessionStorage`ï¼ˆå…³é—­æµè§ˆå™¨åè‡ªåŠ¨æ¸…é™¤ï¼‰
- ç§»åŠ¨åº”ç”¨ï¼šå®‰å…¨çš„æœ¬åœ°å­˜å‚¨ï¼ˆå¦‚ iOS Keychainã€Android Keystoreï¼‰
- åç«¯åº”ç”¨ï¼šæœåŠ¡å™¨å†…å­˜æˆ–å®‰å…¨çš„ç¼“å­˜ç³»ç»Ÿ

---

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- ğŸ“§ Email: xhyovo@qq.com
- ğŸ› Issue: [GitHub Issues](https://github.com/your-repo/issues)

---

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-01-21)
- âœ… åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… æ”¯æŒ OAuth 2.0 æˆæƒç æ¨¡å¼
- âœ… æ”¯æŒ PKCE å®‰å…¨å¢å¼º
- âœ… æä¾›ç”¨æˆ·ä¿¡æ¯æ¥å£
- âœ… æ”¯æŒ Refresh Token

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-01-21
