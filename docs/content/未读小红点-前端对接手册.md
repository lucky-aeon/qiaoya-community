# 未读小红点（文章/题目）前端对接手册

状态：设计稿（已可对接）  
最后更新：2025-10-20  
适用范围：前台导航的“文章/题目/课程章节”未读红点显示与清零（列表级未读）  
术语口径：请先阅读 docs/content/文章与题目-未读数与小红点-列表级未读方案.md

---

## 1. 总览与语义
- 红点数字表示“自上次看过对应列表以来，新发布的可见内容数量”。
- 进入列表后认为“已知晓”，小红点清零；不做逐条已读、列表项不显示已读态。
- 频道维度：文章 POSTS、题目 QUESTIONS、课程章节 CHAPTERS；三者分开计数。

---

## 2. 鉴权与权限
- 鉴权：需要 `Authorization: Bearer <JWT>`（登录后使用）。
- 权限码（PlanPermission，已在后端拦截器声明）：
  - `UNREAD_SUMMARY`：未读汇总接口
  - `UNREAD_VISIT`：进入列表清零接口

---

## 3. 接口定义

### 3.1 获取未读汇总（导航展示）
- 方法：`GET /api/user/unread/summary`
- 响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "postsUnread": 3,
    "questionsUnread": 0,
    "chaptersUnread": 5
  }
}
```
- 语义：若用户首次调用，会为两个频道初始化 lastSeen=当前时间（避免历史大量红点）。

### 3.2 进入频道列表清零
- 方法：`PUT /api/user/unread/visit?channel=POSTS|QUESTIONS|CHAPTERS`
- 响应：
```json
{ "code": 200, "message": "success" }
```
- 语义：用服务端当前时间更新 lastSeen，幂等多次调用安全。

---

## 4. 前端调用时机与策略

### 4.1 导航显示
- 登录后或路由切换到主导航时调用“未读汇总”，渲染红点。
- 轮询刷新：建议 30–60s 定时刷新；页面隐藏时暂停轮询，回到前台立即刷新一次。
- 数字显示策略：建议上限展示（如 `99+`），0 则隐藏红点。

### 4.2 清零（进入列表页）
- 进入文章列表页：在列表数据加载成功后，调用 `PUT /api/user/unread/visit?channel=POSTS`。
- 进入题目列表页：在列表数据加载成功后，调用 `PUT /api/user/unread/visit?channel=QUESTIONS`。
- 并发与重入：同一路由短时间内多次调用不影响结果；失败可重试，或在下一次进入时覆盖。

### 4.3 跨端一致性
- lastSeen 存在服务端；任一设备/浏览器进入列表后，所有端的红点会一起清零（下次轮询或刷新生效）。

---

## 5. 前端伪代码（示例）
> 仅示意时序与要点，实际按你的框架/状态管理适配即可。

### 5.1 导航红点加载与轮询
```ts
// onAppReady or onAuthSuccess
loadUnread();
startPolling(loadUnread, { intervalMs: 60000, pauseWhenHidden: true });

async function loadUnread() {
  const res = await api.get('/api/user/unread/summary');
  state.postsUnread = clamp99Plus(res.data.postsUnread);
  state.questionsUnread = clamp99Plus(res.data.questionsUnread);
}
```

### 5.2 进入列表后的清零
```ts
// onEnterRoute('/posts') 列表加载成功后
await api.put('/api/user/unread/visit', { params: { channel: 'POSTS' } });
// 随后触发一次 loadUnread() 以确保导航同步更新
```

---

## 6. 边界与常见问题
- 编辑是否触发红点：否。本期口径仅统计“新发布”（依据 publishTime），编辑不会产生红点。
- 首次登录显示很多红点？不会。首次为用户初始化 lastSeen 为当前时间。
- 切到列表马上清零是否会“来回抖动”？进入列表后再清零即可；若担心抖动，可在清零后短暂抑制导航区域的下一次自动刷新（如 2–3s）。
- 需要逐条已读状态？不在本方案范围；若后续需要，参考“列表级未读方案”文档中的可演进路线。

---

## 7. 对接检查清单
- [ ] 导航加载后立即请求 `/api/user/unread/summary`
- [ ] 页面隐藏时暂停轮询；回到前台立即刷新
- [ ] 进入文章/题目列表后调用 `/api/user/unread/visit` 清零
- [ ] 红点 UI 做 `99+` 上限显示，0 隐藏
- [ ] 处理接口失败的降级与重试（不阻塞页面使用）

---

## 8. 变更记录
- v1（2025-10-20）：首次发布，配套列表级未读方案落地（App 层 `UnreadAppService`）。
// 进入课程章节列表页
await api.put('/api/user/unread/visit', { params: { channel: 'CHAPTERS' } });
// 同步刷新导航红点
