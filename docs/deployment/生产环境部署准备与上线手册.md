# 敲鸭社区后端 生产环境部署准备与上线手册

作者：后端
最后更新：2025-10-06
状态：可落地（首版）
适用范围：将现有“测试环境”扩展为“生产环境”的部署与运维准备

维护人：后端
关键文件：
- Dockerfile（项目根目录）
- .github/workflows/dev-deploy.yml（测试环境）
- .github/workflows/release-deploy.yml（生产/预发/Tag）
- deploy/env/qiaoya.backend.env.example（环境变量样例）
- docs/deployment/Nginx-Traefik-蓝绿切流-运维操作手册.md（流量切换）
- docs/deployment/后端CI-CD技术方案-GitHub-Actions-SSH-Docker.md（CI/CD 说明）
- docs/deployment/PostgreSQL备份与恢复实践.md（DB 备份/PITR）

---

## 1. 环境分层与命名

- 环境划分：
  - 开发（dev）：分支开发与联调
  - 测试（test）：当前已运行的测试服务器/环境
  - 生产（prod）：对外正式提供服务的环境

- 分支与触发：
  - test：`dev` 分支推送自动构建与部署（已落地）
  - prod：打 Tag（`v*`）触发构建与生产部署（需完善审批与防护）

- 域名与证书建议：
  - 测试：`api.test.qiaoya.xxx`、`admin.test.qiaoya.xxx`
  - 生产：`api.qiaoya.xxx`、`admin.qiaoya.xxx`
  - HTTPS/TLS：分别签发证书；启用 HSTS 与 HTTP→HTTPS 重定向

- GitHub Environments：
  - 新建 `production` 环境，开启保护规则：必需审批人、等待时间（可选），限制密钥可见性

---

## 2. 生产基础设施准备

### 2.1 服务器与系统
- 资源建议（首版参考）：2–4 vCPU、8–16GB RAM、SSD ≥ 100GB（含日志/归档空间）
- 系统参数：
  - 时区使用 UTC；启用 NTP 时间同步
  - 文件描述符 `nofile` ≥ 65535；内核参数适度优化（保守）
  - 防火墙：对外仅开放 80/443，应用端口（8520）仅内网可达

### 2.2 依赖安装
- Docker（必需）与 Buildx/Compose 插件
- Traefik 或 Nginx（反向代理 + TLS 终端）
- 日志/监控 Agent（如 node_exporter、promtail/Vector、cloudwatch/日志服务）

### 2.3 目录与账户
- 统一目录建议：
  - 应用：`/www/project/qiaoya/`（容器外放置部署脚本/缓存）
  - 环境变量：`/etc/qiaoya.backend.prod.env`
  - 反向代理：`/etc/traefik/` 或 `/etc/nginx/`
  - 备份与数据：`/backup/pg/{wal,base,logic}`（PostgreSQL）
- 账户最小权限：Docker 组权限、只读密钥，禁用密码登录，仅用 SSH 公钥

---

## 3. 应用配置与密钥管理（prod）

### 3.1 环境变量文件
- 基于 `deploy/env/qiaoya.backend.env.example` 复制一份生产专用：`/etc/qiaoya.backend.prod.env`
- 关键差异：
  - `SPRING_PROFILES_ACTIVE=prod`
  - 指向生产 PostgreSQL/Redis/OSS/邮件等真实服务
  - 打开安全项（如 Cookie Secure、CORS 精确白名单、限流/防刷）

示例（节选，按需补齐）：
```env
# JVM
JAVA_TOOL_OPTIONS=-Xms1024m -Xmx1024m -XX:+UseG1GC

# Spring Profile
SPRING_PROFILES_ACTIVE=prod

# DB
DB_HOST=10.0.0.10
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=strong-password

# Redis
REDIS_HOST=10.0.0.11
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DATABASE=0

# 站点域名（用于生成回调/链接）
PUBLIC_BASE_URL=https://api.qiaoya.xxx
ADMIN_BASE_URL=https://admin.qiaoya.xxx
```

注意：
- 秘钥统一放在 `Actions → Environments → production → Secrets` 中供工作流使用（例如 SSH、镜像仓库登陆、对象存储 Key）
- 服务器上的 `/etc/qiaoya.backend.prod.env` 仅包含运行必需的应用层变量，不含仓库密钥

### 3.2 安全基线
- CORS：只允许生产域名，禁用 `*`
- Cookie：`Secure; SameSite=Lax/Strict`；仅 HTTPS
- JWT/签名：生产与测试密钥分离，限制暴露
- Actuator：仅对内网/局域网开放健康检查端点（或经反向代理做 Basic Auth）
- 日志：级别 `INFO`，脱敏敏感字段（手机号/邮箱/Token 等）

---

## 4. 数据库与状态服务（生产）

### 4.1 PostgreSQL（必读）
- 备份：启用物理备份 + WAL 归档，支持 PITR（详见 docs/deployment/PostgreSQL备份与恢复实践.md）
- 参数：连接池大小按 QPS 与 CPU 评估（JDBC/Hikari ↔ PG max_connections）
- Flyway 迁移：
  - 生产默认开启自动迁移，但需配合“发布窗口 + 备份 + 演练”
  - 破坏性变更（删列/重建索引/写放大）应在低峰期执行，或拆分为多次上线
  - 上线前创建备份点；上线失败可按 PITR 回退

### 4.2 Redis
- 使用托管/独立实例；禁止对外网开放
- 设置合理的超时与重试；明确使用模式（缓存/队列）与数据丢失风险

---

## 5. CI/CD（生产）

### 5.1 流程设计
- 触发：推送 Tag `v*`（如 `v1.2.3`）
- CI：构建 Jar → 构建并推送镜像（标记 `<tag>` 与 `prod-latest`）
- CD：SSH 到生产服务器 → 登录镜像仓库 → 拉镜像 → `docker run` 预部署 → 健康检查/冒烟 → 蓝绿切流 → 观察 → 完成
- 防护：GitHub Environments `production` 要求审批；保护分支/Tag 规则；仅受限 Secrets 可见

### 5.2 预部署与健康检查
- 预部署建议在备用端口或备用容器（蓝/绿）：
  - 例：`qiaoya-backend-green` 在 8521 端口启动，健康后由 Traefik/Nginx 切换流量（参考对应运维文档）
- 健康检查：`/actuator/health` 或业务最小探活接口
- 冒烟用例（最小集）：
  - 连接 DB/Redis 正常
  - 关键接口 200 且响应时间可接受
  - 管理端登录/鉴权链路正常

### 5.3 生产部署脚本（示例命令）
```bash
# 拉取镜像（以 GHCR 为例）
docker pull ghcr.io/<owner>/<repo>:v1.2.3

# 预部署（Green）
docker stop qiaoya-backend-green || true && docker rm qiaoya-backend-green || true

docker run -d --name qiaoya-backend-green \
  --env-file /etc/qiaoya.backend.prod.env \
  -e SPRING_PROFILES_ACTIVE=prod \
  -p 8521:8520 \
  --restart=always \
  ghcr.io/<owner>/<repo>:v1.2.3

# 冒烟 + 健康检查（通过后执行流量切换）
# ...参见 Nginx/Traefik 文档进行蓝绿切流...
```

---

## 6. 上线清单（Checklist）

上线前：
- 需求/变更评审已通过，发布窗口确认，回滚方案可行
- 生产 DB 备份/PITR 可用；已做恢复演练（至少季度一次）
- Flyway 脚本通过测试环境验证；大表变更评估影响与时长
- 证书有效期检查、DNS 生效校验、CDN/缓存策略准备
- 监控面板与告警阈值已配置：错误率、P95 延迟、CPU、内存、连接数、WAL backlog、磁盘空间
- 生产 env-file 与 Secrets 就绪；管理员账号/操作权限正常

上线中：
- 以 Tag 触发工作流，CI 构建与推送成功
- 预部署容器健康，冒烟通过
- 蓝绿切流：小流量（可金丝雀 5–10%）观察 10–15 分钟
- 指标稳定后全量切换，保留旧版本容器待命

上线后：
- 观察 1–2 小时：错误率、延迟、资源使用、DB 负载
- 核对核心链路数据与业务侧验收
- 确认计划任务/异步消费运行正常
- 记录上线总结与指标截屏，存档

---

## 7. 回滚策略

- 应用回滚：
  - 直接将反向代理流量切回旧容器（Blue）
  - 或停止新容器并启动上一版本镜像（保留 `prod-prev` Tag）
- 数据回滚：
  - 优先采用前向兼容迁移，避免需要“数据回滚”
  - 若必须回滚到某时点，按 PITR 文档在备机/新实例中验证后替换
- 配置回滚：
  - env-file 与反向代理配置均需版本化/留存备份

---

## 8. 监控与日志（生产）

- 指标：
  - 应用：QPS、P50/P95、错误率（5xx/4xx）、线程池/连接池使用率、队列堆积
  - 数据库：连接数、慢查询、WAL 归档延迟、磁盘空间
  - 系统：CPU、内存、磁盘 IO、网络吞吐
- 日志：
  - 结构化输出（JSON 可选）；集中采集（ELK/ClickHouse/S3）
  - 保留策略与脱敏检查
- 告警：
  - 通用：错误率上升、延迟飙升、资源逼近阈值
  - 特殊：归档失败、备份失败、磁盘逼近阈值

---

## 9. 安全与合规

- GitHub Environments 限制 Secrets 可见性与部署者审批
- 生产服务器 SSH 仅白名单源，禁止密码登录
- 最小权限：数据库账号按角色划分（应用读写、只读、迁移）
- 密钥与 Token 轮转计划；审计生产变更（工单/变更记录）

---

## 10. 附录

### 10.1 生产 env-file 样例路径
- `/etc/qiaoya.backend.prod.env`（权限 600）

### 10.2 生产运行命令（直连反向代理 upstream 场景）
```bash
# 生产容器（Blue）
docker run -d --name qiaoya-backend-blue \
  --env-file /etc/qiaoya.backend.prod.env \
  -e SPRING_PROFILES_ACTIVE=prod \
  -p 8520:8520 \
  --restart=always \
  ghcr.io/<owner>/<repo>:v1.2.3
```

### 10.3 参考文档
- CI/CD：docs/deployment/后端CI-CD技术方案-GitHub-Actions-SSH-Docker.md
- 蓝绿切流：docs/deployment/Nginx-Traefik-蓝绿切流-运维操作手册.md
- PostgreSQL：docs/deployment/PostgreSQL备份与恢复实践.md
