# 发布可靠性与回滚策略（蓝绿 / 金丝雀 / 候选容器预检）

作者：后端
最后更新：2025-09-27
状态：设计稿（可落地，分阶段）
适用范围：Docker + SSH 脚本式部署；可选 Nginx/Traefik 代理；GitHub Actions CI/CD

维护人：后端
关键文件：
- `deploy/scripts/deploy-qiaoya.sh`:1（容器部署脚本，当前先停删旧容器后启动新容器）
- `.github/workflows`:1（dev 与 release 工作流，镜像构建与远程部署）
- `Dockerfile`:1（构建/运行镜像配置）
- `src/main/resources/application.yml`:93（Actuator 管理端点，`/actuator/health`）

---

## 1. 背景与问题

- 风险：当前脚本会“停止并删除旧容器→拉起新容器”。如果新镜像有问题或启动变慢，将出现服务不可用窗口，甚至完全启动失败（全站不可用）。
- 回滚困难：dev 环境使用 `dev-latest`，无法方便地“一键回滚到上一版”。
- 验证不足：缺少“镜像启动自检/健康检查通过”作为切换前置门槛。

目标：
- 可回滚：任意时刻可快速恢复到上一稳定版本。
- 减影响：新版本异常时，尽量不影响对外服务或只影响小比例流量。
- 可验证：切流前通过自动健康检查和冒烟测试筛掉坏镜像。
- 可观测：失败能被及时发现并触发自动/半自动回滚。

---

## 2. 现状（仓库基线）

- 部署脚本：`deploy/scripts/deploy-qiaoya.sh`:1 先停删旧容器，再 `docker run` 启动新容器，最后清理旧镜像。
- 镜像与标签：
  - dev 工作流使用 `dev-latest` 部署（不利于回滚）。
  - release 工作流对生产使用版本 Tag（如 `v1.2.3`），可以回滚到任意历史版本。
- 健康检查：`application.yml` 已暴露 `/actuator/health`、`info`、`metrics`，可用于健康检查。
- 运行方式：单容器直暴露 `8520`，未显式引入前置代理/网关做灰度切换。

---

## 3. 策略对比（择优组合）

- 候选容器预检（最小改造）
  - 启动“候选容器”但不切流，先做健康检查/冒烟测试，通过后再替换旧容器。
  - 优点：不需引入代理或编排平台，落地快；失败不影响线上旧容器。
  - 缺点：最终替换时仍可能有极短停机窗口（停旧→起新）。

- 蓝绿发布（Blue/Green）
  - 同时运行两套实例（blue/green）并通过代理切流；失败即可瞬时切回。
  - 优点：切换与回滚几乎无中断；验证更充分。
  - 前提：有前置代理（Nginx/Traefik/SLB）或负载均衡。

- 金丝雀发布（Canary）
  - 先将小比例流量导向新版本，观察指标逐步放量，异常自动停止/回滚。
  - 优点：风险最小化；适合高可用要求。
  - 前提：需要支持按权重/特征切流与完善的监控门槛。

---

## 4. 分阶段落地路径

### 阶段一：候选容器预检（保持单机脚本）

适合：当前部署模式（`docker run` + env-file），无需新增基础设施。

建议步骤（脚本层面行为）：
1) 拉起“候选容器”
   - 使用不同容器名（如 `qiaoya-community-backend-cand`）与不同宿主端口（例如 `:18520->8520`）。
   - 注入与生产相同的 `--env-file` 与 `SPRING_PROFILES_ACTIVE`。
2) 健康检查与冒烟测试
   - 轮询 `http://127.0.0.1:18520/actuator/health`，在 60~120 秒内必须返回 `UP`。
   - 可追加冒烟用例（登录/首页/关键读写路径）。
3) 切换与替换
   - 仅当候选容器健康/冒烟通过，才执行“停旧容器→启动新正式容器（绑定 8520）”。
   - 若预检失败：删除候选容器并中止部署，旧容器持续对外服务。
4) 镜像与回滚
   - dev 环境建议改用 `dev-<sha>` 进行部署，保留最近 3~5 个镜像版本以便快速回滚。
   - prod 继续使用版本 Tag（`v*`），回滚直接指定上一个稳定 Tag 部署。

验收标准：
- 新镜像启动失败不会影响线上旧容器。
- 切换时仅有极短窗口；可通过预热/连接保持与代理缓冲进一步缩短。

### 阶段二：蓝绿发布（引入前置代理）

适合：对零中断与快速回滚有要求的生产环境。

基础形态：
- 运行两个容器池：`backend-blue`（8520）、`backend-green`（8521）。
- 前置代理（Nginx/Traefik）对外提供固定端口/域名，仅切换 upstream（权重 100/0 → 0/100）。

发布流程：
1) 启动 green（新镜像），完成健康检查与冒烟测试（同阶段一）。
2) 代理切流到 green（原子切换，基本无中断）。
3) 观察 5~10 分钟：监控错误率/延迟/业务 KPI。
4) 无异常：下线 blue；若异常：立即切回 blue 并分析。

优点：
- 切换/回滚在秒级完成；就绪后才接流量；上线窗口影响极小。

### 阶段三：CI 门禁 + 自动化回滚（门槛与守护）

CI 阶段门禁：
- 容器级自验证：在 CI 用构建出的镜像本地起容器，跑 `/actuator/health` 与关键冒烟。
- 安全与质量：依赖与镜像扫描、代码扫描、单元/集成测试。

CD 阶段守护：
- 发布后自动观察 10~30 分钟：
  - 技术指标：5xx 错误率阈值、P95 延迟阈值、启动失败告警。
  - 业务指标：登录成功率/下单成功率等核心 KPI 阈值。
- 触发条件：超阈则自动暂停扩容/自动切回上一稳定版本（蓝绿切回或重发上一 Tag）。

镜像与标签策略：
- 生产只用版本化 Tag（禁用 `latest`）；dev 使用 `dev-<sha>`。
- 设定镜像保留策略（至少最近 3~5 个版本）。

---

## 5. 数据库迁移与状态管理

- 迁移方式：严格遵循“向后兼容（Expand）→ 上线 → 稳定期 → 收缩（Contract）”。
- 备份策略：发布前快照/备份；大表变更采用在线 DDL 或分批迁移。
- 会话/缓存：跨版本兼容，避免切流后用户需强制重登或出现序列化错误。

---

## 6. 可观测性与告警

- 健康检查：统一使用 `/actuator/health`；必要时区分 `readiness`/`liveness`（可按需开启探针分组）。
- 指标体系：
  - 技术：请求计数、错误率、P95/P99 延迟、JVM 内存、数据库连接池、Redis 连接。
  - 业务：登录/下单/活跃等核心成功率。
- 发布观察面板：发布时自动打开 30 分钟观察面板（可在 CI 中集成链接）。
- 告警：构建失败/部署失败/健康检查失败/指标越阈即时通知。

---

## 7. 回滚与演练（SOP）

标准回滚（生产）：
- 方式 A：指定历史 Tag 重新部署（脚本保持不变）：
  ```bash
  IMAGE=ghcr.io/<owner>/<repo>:vX.Y.Z PROFILE=prod /www/project/qiaoya/deploy-qiaoya.sh
  ```
- 方式 B：在 GitHub 上对该 Tag 重新运行 Release 工作流（Re-run）。

紧急回退：
- 新版本无法启动/健康检查失败：
  - 阶段一：直接删除候选容器，旧容器继续服务；或立即用上一 Tag 重发一次。
  - 阶段二（蓝绿）：代理立即切回上一池（blue/green）。

演练频率：
- 建议每月或每两月进行一次“演练回滚”，验证脚本/镜像保留/代理切换均可用。

---

## 8. 最小落地清单（按优先级）

1) 候选容器预检（脚本改造）
- [ ] 启动候选容器到备用端口
- [ ] 轮询 `/actuator/health` 通过后才替换
- [ ] 失败则中止并清理候选容器

2) 标签与保留策略
- [ ] dev 改为 `dev-<sha>` 部署，保留 N 个版本
- [ ] prod 仅用版本 Tag，保留 N 个版本

3) 蓝绿与切流（可选/推荐生产）
- [ ] 引入 Nginx/Traefik 代理
- [ ] 预置 blue/green 两套端口
- [ ] 切流/回流脚本化

4) 门禁与守护
- [ ] CI 容器级健康/冒烟
- [ ] 发布后 10~30 分钟自动观察与阈值回滚

---

## 9. 参考与关联

- 现有 CI/CD 方案文档：`docs/deployment/后端CI-CD技术方案-GitHub-Actions-SSH-Docker.md`:1
- 可观测性方案：`docs/observability/Prometheus指标接入与打点方案.md`:1
- 部署脚本：`deploy/scripts/deploy-qiaoya.sh`:1
- 健康端点配置：`src/main/resources/application.yml`:93

