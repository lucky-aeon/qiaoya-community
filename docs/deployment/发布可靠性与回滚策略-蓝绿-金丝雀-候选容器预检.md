# 发布可靠性与回滚策略（蓝绿 / 金丝雀 / 候选容器预检）

作者：后端
最后更新：2025-09-27
状态：设计稿（可落地，分阶段）
适用范围：Docker + SSH 脚本式部署；可选 Nginx/Traefik 代理；GitHub Actions CI/CD

维护人：后端
关键文件：
- `deploy/scripts/deploy-qiaoya.sh`:1（容器部署脚本，当前先停删旧容器后启动新容器）
- `.github/workflows`:1（dev 与 release 工作流，镜像构建与远程部署）
- `Dockerfile`:1（构建/运行镜像配置）
- `src/main/resources/application.yml`:93（Actuator 管理端点，`/actuator/health`）

---

## 1. 背景与问题

- 风险：当前脚本会“停止并删除旧容器→拉起新容器”。如果新镜像有问题或启动变慢，将出现服务不可用窗口，甚至完全启动失败（全站不可用）。
- 回滚困难：dev 环境使用 `dev-latest`，无法方便地“一键回滚到上一版”。
- 验证不足：缺少“镜像启动自检/健康检查通过”作为切换前置门槛。

目标：
- 可回滚：任意时刻可快速恢复到上一稳定版本。
- 减影响：新版本异常时，尽量不影响对外服务或只影响小比例流量。
- 可验证：切流前通过自动健康检查和冒烟测试筛掉坏镜像。
- 可观测：失败能被及时发现并触发自动/半自动回滚。

---

## 2. 现状（仓库基线）

- 部署脚本：`deploy/scripts/deploy-qiaoya.sh`:1 先停删旧容器，再 `docker run` 启动新容器，最后清理旧镜像。
- 镜像与标签：
  - dev 工作流使用 `dev-latest` 部署（不利于回滚）。
  - release 工作流对生产使用版本 Tag（如 `v1.2.3`），可以回滚到任意历史版本。
- 健康检查：`application.yml` 已暴露 `/actuator/health`、`info`、`metrics`，可用于健康检查。
- 运行方式：单容器直暴露 `8520`，未显式引入前置代理/网关做灰度切换。

---

## 3. 策略对比（择优组合）

- 候选容器预检（最小改造）
  - 启动“候选容器”但不切流，先做健康检查/冒烟测试，通过后再替换旧容器。
  - 优点：不需引入代理或编排平台，落地快；失败不影响线上旧容器。
  - 缺点：最终替换时仍可能有极短停机窗口（停旧→起新）。

- 蓝绿发布（Blue/Green）
  - 同时运行两套实例（blue/green）并通过代理切流；失败即可瞬时切回。
  - 优点：切换与回滚几乎无中断；验证更充分。
  - 前提：有前置代理（Nginx/Traefik/SLB）或负载均衡。

- 金丝雀发布（Canary）
  - 先将小比例流量导向新版本，观察指标逐步放量，异常自动停止/回滚。
  - 优点：风险最小化；适合高可用要求。
  - 前提：需要支持按权重/特征切流与完善的监控门槛。

---

## 4. 分阶段落地路径

### 阶段一：候选容器预检（保持单机脚本）

适合：当前部署模式（`docker run` + env-file），无需新增基础设施。

建议步骤（脚本层面行为）：
1) 拉起“候选容器”
   - 使用不同容器名（如 `qiaoya-community-backend-cand`）与不同宿主端口（例如 `:18520->8520`）。
   - 注入与生产相同的 `--env-file` 与 `SPRING_PROFILES_ACTIVE`。
2) 健康检查与冒烟测试
   - 轮询 `http://127.0.0.1:18520/actuator/health`，在 60~120 秒内必须返回 `UP`。
   - 可追加冒烟用例（登录/首页/关键读写路径）。
3) 切换与替换
   - 仅当候选容器健康/冒烟通过，才执行“停旧容器→启动新正式容器（绑定 8520）”。
   - 若预检失败：删除候选容器并中止部署，旧容器持续对外服务。
4) 镜像与回滚
   - dev 环境建议改用 `dev-<sha>` 进行部署，保留最近 3~5 个镜像版本以便快速回滚。
   - prod 继续使用版本 Tag（`v*`），回滚直接指定上一个稳定 Tag 部署。

验收标准：
- 新镜像启动失败不会影响线上旧容器。
- 切换时仅有极短窗口；可通过预热/连接保持与代理缓冲进一步缩短。

### 阶段二：蓝绿发布（引入前置代理）

适合：对零中断与快速回滚有要求的生产环境。

基础形态：
- 运行两个容器池：`backend-blue`（8520）、`backend-green`（8521）。
- 前置代理（Nginx/Traefik）对外提供固定端口/域名，仅切换 upstream（权重 100/0 → 0/100）。

发布流程：
1) 启动 green（新镜像），完成健康检查与冒烟测试（同阶段一）。
2) 代理切流到 green（原子切换，基本无中断）。
3) 观察 5~10 分钟：监控错误率/延迟/业务 KPI。
4) 无异常：下线 blue；若异常：立即切回 blue 并分析。

优点：
- 切换/回滚在秒级完成；就绪后才接流量；上线窗口影响极小。

### 阶段三：CI 门禁 + 自动化回滚（门槛与守护）

CI 阶段门禁：
- 容器级自验证：在 CI 用构建出的镜像本地起容器，跑 `/actuator/health` 与关键冒烟。
- 安全与质量：依赖与镜像扫描、代码扫描、单元/集成测试。

CD 阶段守护：
- 发布后自动观察 10~30 分钟：
  - 技术指标：5xx 错误率阈值、P95 延迟阈值、启动失败告警。
  - 业务指标：登录成功率/下单成功率等核心 KPI 阈值。
- 触发条件：超阈则自动暂停扩容/自动切回上一稳定版本（蓝绿切回或重发上一 Tag）。

镜像与标签策略：
- 生产只用版本化 Tag（禁用 `latest`）；dev 使用 `dev-<sha>`。
- 设定镜像保留策略（至少最近 3~5 个版本）。

---

## 5. 数据库迁移与状态管理

- 迁移方式：严格遵循“向后兼容（Expand）→ 上线 → 稳定期 → 收缩（Contract）”。
- 备份策略：发布前快照/备份；大表变更采用在线 DDL 或分批迁移。
- 会话/缓存：跨版本兼容，避免切流后用户需强制重登或出现序列化错误。

---

## 6. 可观测性与告警

- 健康检查：统一使用 `/actuator/health`；必要时区分 `readiness`/`liveness`（可按需开启探针分组）。
- 指标体系：
  - 技术：请求计数、错误率、P95/P99 延迟、JVM 内存、数据库连接池、Redis 连接。
  - 业务：登录/下单/活跃等核心成功率。
- 发布观察面板：发布时自动打开 30 分钟观察面板（可在 CI 中集成链接）。
- 告警：构建失败/部署失败/健康检查失败/指标越阈即时通知。

---

## 7. 回滚与演练（SOP）

标准回滚（生产）：
- 方式 A：指定历史 Tag 重新部署（脚本保持不变）：
  ```bash
  IMAGE=ghcr.io/<owner>/<repo>:vX.Y.Z PROFILE=prod /www/project/qiaoya/deploy-qiaoya.sh
  ```
- 方式 B：在 GitHub 上对该 Tag 重新运行 Release 工作流（Re-run）。

紧急回退：
- 新版本无法启动/健康检查失败：
  - 阶段一：直接删除候选容器，旧容器继续服务；或立即用上一 Tag 重发一次。
  - 阶段二（蓝绿）：代理立即切回上一池（blue/green）。

演练频率：
- 建议每月或每两月进行一次“演练回滚”，验证脚本/镜像保留/代理切换均可用。

---

## 8. 最小落地清单（按优先级）

1) 候选容器预检（脚本改造）
- [ ] 启动候选容器到备用端口
- [ ] 轮询 `/actuator/health` 通过后才替换
- [ ] 失败则中止并清理候选容器

2) 标签与保留策略
- [ ] dev 改为 `dev-<sha>` 部署，保留 N 个版本
- [ ] prod 仅用版本 Tag，保留 N 个版本

3) 蓝绿与切流（可选/推荐生产）
- [ ] 引入 Nginx/Traefik 代理
- [ ] 预置 blue/green 两套端口
- [ ] 切流/回流脚本化

4) 门禁与守护
- [ ] CI 容器级健康/冒烟
- [ ] 发布后 10~30 分钟自动观察与阈值回滚

---

## 9. 参考与关联

- 现有 CI/CD 方案文档：`docs/deployment/后端CI-CD技术方案-GitHub-Actions-SSH-Docker.md`:1
- 可观测性方案：`docs/observability/Prometheus指标接入与打点方案.md`:1
- 部署脚本：`deploy/scripts/deploy-qiaoya.sh`:1
- 健康端点配置：`src/main/resources/application.yml`:93


---

## 10. 蓝绿上游配置与切流操作清单（Nginx / Traefik）

说明：以下仅为运维侧配置与步骤示例，不涉及代码改动。目标是让对外暴露的入口始终稳定，切换仅发生在网关/代理的 upstream 内。

### 10.1 Nginx（权重切换/蓝绿切换）

- 上游（示例：本机两端口 blue:8520、green:8521）
```
upstream qiaoya_backend {
    # blue（旧版本）
    server 127.0.0.1:8520 weight=100 max_fails=3 fail_timeout=10s;
    # green（新版本）
    server 127.0.0.1:8521 weight=0;
}

server {
    listen 80;
    server_name api.example.com;  # 调整为你的域名

    # 可选：基础反向代理优化
    proxy_connect_timeout 5s;
    proxy_read_timeout    60s;
    proxy_send_timeout    60s;
    proxy_http_version    1.1;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP $remote_addr;
    proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;

    location / {
        proxy_pass http://qiaoya_backend;
    }
}
```

- 切流操作步骤
  1) 在服务器先启动 green 容器（监听 8521），完成候选预检（`/actuator/health` 返回 `UP`，冒烟用例通过）。
  2) 调整 `upstream qiaoya_backend` 的权重：
     - 蓝绿切换：将 green 改为 `weight=100`，blue 改为 `weight=0`。
     - 金丝雀：按 95/5、90/10、50/50、100/0 逐步放量。
  3) 检查配置：`nginx -t`。
  4) 平滑生效：`nginx -s reload` 或 `systemctl reload nginx`。
  5) 观察 5~10 分钟指标与业务 KPI；异常则反向调整权重并 reload（回滚）。

备注：开源 Nginx 不带主动健康探测指令；健康检查统一依赖应用就绪/存活探针与候选预检，生产建议配合监控阈值与快速回滚。

### 10.2 Traefik（Weighted 服务平滑切换）

- 静态配置（示例，保留 File Provider 并监听 80）
```
# traefik.yml（静态）
entryPoints:
  web:
    address: ":80"
providers:
  file:
    filename: /etc/traefik/dynamic/qiaoya.yml
    watch: true
```

- 动态配置（weighted service，blue:8520 / green:8521）
```
# /etc/traefik/dynamic/qiaoya.yml（动态，可热加载）
http:
  routers:
    qiaoya:
      rule: Host(`api.example.com`)
      entryPoints: [ web ]
      service: qiaoya-weighted

  services:
    qiaoya-weighted:
      weighted:
        services:
          - name: qiaoya-blue
            weight: 100   # 初始全量 blue
          - name: qiaoya-green
            weight: 0     # green 预热，先不接流

    qiaoya-blue:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:8520"

    qiaoya-green:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:8521"
```

- 切流操作步骤
  1) 先在服务器起好 green 并完成候选预检。
  2) 修改动态文件中的权重：
     - 蓝绿切换：`qiaoya-green.weight=100`、`qiaoya-blue.weight=0`。
     - 金丝雀：按 95/5、90/10、50/50、100/0 逐步放量。
  3) 保存后 Traefik 会自动热更新（`providers.file.watch=true`）。
  4) 观察 5~10 分钟；异常则回调权重并保存（即时回滚）。

可选增强：为 Traefik 配置 `forwardingTimeouts`、`serversTransport` 等以优化超时与 TLS；如需粘性会话可结合 JWT 无状态策略或 Traefik Sticky（需权衡）。

---

## 11. CI 阶段“容器级冒烟测试”用例清单

说明：在 CI 构建镜像后，使用该镜像本地起容器（或在独立 Runner/VM 上），针对关键路径做轻量自验证。以下以默认端口 `8520` 为例，`BASE=http://127.0.0.1:8520`。

### 11.1 基础健康与管理端点
- GET `${BASE}/actuator/health`
  - 期望：200，JSON 中 `status=UP`（允许短轮询重试，超时 60~120s）。
- GET `${BASE}/actuator/info`
  - 期望：200，返回应用信息（可为空结构）。
- 可选：GET `${BASE}/actuator/metrics`
  - 期望：200，列表中包含 `http.server.requests`。

### 11.2 公开接口（无需鉴权）
- GET `${BASE}/api/public/stats/users`
  - 期望：200，`ApiResponse` 结构；数据字段存在（数值可为 0）。
- GET `${BASE}/api/public/testimonials`
  - 期望：200，列表（可为空）。
- GET `${BASE}/api/public/subscription-plans`
  - 期望：200，列表（可为空）。
- 可选：`/api/public/courses`
  - POST `${BASE}/api/public/courses/queries`（如需体检分页与检索，需按请求体约定构造最小查询；若不准备数据可跳过）。

### 11.3 扩展（条件允许时）
- 登录/注册链路（如邮件服务在 CI 环境不可用，建议跳过注册验证码流程）：
  - POST `${BASE}/api/auth/login` 使用一组“测试账号”凭证（需事先准备测试数据或通过启动脚本预置）。
  - 期望：200，返回 `token` 与 `user` 字段。
- 管理接口基础鉴权（需准备 admin 令牌）：
  - GET `${BASE}/api/admin/orders` 携带 `Authorization: Bearer <token>`。
  - 期望：200，可为空分页。

### 11.4 判定与处理
- 任何一步失败（超时/非 2xx）均判定为“冒烟失败”，阻断部署。
- 所有检查通过，才允许进入部署或放量阶段。

