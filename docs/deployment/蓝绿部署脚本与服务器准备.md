# 生产蓝绿部署脚本与服务器准备（一步步上手）

目标：用脚本把“预部署 → 健康检查 → 切流 → 回滚/收尾”自动化，减少手工出错。

关联：
- 蓝绿/金丝雀操作原则与 Nginx/Traefik 配置细节：docs/deployment/Nginx-Traefik-蓝绿切流-运维操作手册.md
- 生产部署手册：docs/deployment/生产环境部署准备与上线手册.md

---

## 1. 服务器准备

- 安装 Docker、Nginx（或 Traefik）
- 生产环境变量文件：`/etc/qiaoya.backend.prod.env`（权限 600）
  - 样例：`deploy/env/qiaoya.backend.prod.env.example`
- 代理端口/域名：Nginx 对外 80/443；后端容器对内使用 8520（blue）与 8521（green）
- 放置脚本：
  ```bash
  sudo install -d -m 755 /www/project/qiaoya
  scp deploy/scripts/deploy-qiaoya-bluegreen.sh <user>@<host>:/www/project/qiaoya/
  ssh <user>@<host> 'chmod +x /www/project/qiaoya/deploy-qiaoya-bluegreen.sh'
  ```

---

## 2. Nginx 配置（权重切换示例）

文件：`/etc/nginx/conf.d/qiaoya.conf`
```
upstream qiaoya_backend {
    server 127.0.0.1:8520 weight=100 max_fails=3 fail_timeout=10s; # blue
    server 127.0.0.1:8521 weight=0;                                # green
}

server {
    listen 443 ssl;  # 证书略
    server_name api.qiaoya.example;

    location / {
        proxy_pass http://qiaoya_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

切流思路：blue 权重从 100→0，green 从 0→100。脚本可自动执行该替换并 reload。

---

## 3. 使用脚本（本机手动）

命令（将镜像、域名等替换为你的实际值）：
```bash
IMAGE=registry.cn-hangzhou.aliyuncs.com/your_ns/qiaoya-community:v1.2.3 \
PROFILE=prod ENV_FILE=/etc/qiaoya.backend.prod.env \
UPSTREAM_SWITCH=nginx NGINX_CONF=/etc/nginx/conf.d/qiaoya.conf \
/www/project/qiaoya/deploy-qiaoya-bluegreen.sh
```

脚本步骤：
1) 拉取镜像
2) 启动 `qiaoya-community-backend-green`（映射 8521）
3) 健康检查 `http://127.0.0.1:8521/actuator/health` 为 UP
4) 自动将 Nginx 权重切到 green 并 reload（如设置 `UPSTREAM_SWITCH=nginx`）
5) 保留 blue 作为回滚容器（传 `RETIRE_OLD=1` 可自动下线 blue）

回滚：
- 将 `UPSTREAM_SWITCH=nginx` 再次执行脚本（会把权重调回 blue=100/green=0），或手动编辑 Nginx 并 reload

---

## 4. 与 GitHub Actions 集成（可选）

发布工作流 `.github/workflows/release-deploy.yml` 已支持通过 Secrets 指定远端脚本路径：
- 设置仓库 Secret：`DEPLOY_SCRIPT_PATH=/www/project/qiaoya/deploy-qiaoya-bluegreen.sh`
- 在同一处（prod 部署步骤）添加环境变量（envs）：
  - `UPSTREAM_SWITCH=nginx`
  - `NGINX_CONF=/etc/nginx/conf.d/qiaoya.conf`
  - `ENV_FILE=/etc/qiaoya.backend.prod.env`

工作流会在服务器上调用上述脚本，实现“预部署→探活→切流”。

---

## 5. 常见问题

- 502/504：green 未就绪或 proxy 超时太短；用 `docker logs` 与 `nginx -t && nginx -s reload` 排查
- 健康检查失败：默认检查 200 或 JSON `status=UP`；可改 `HEALTH_PATH=/api/public/health`
- 私有仓库拉取失败：在工作流与服务器侧都配置国内仓库登录（CN_REGISTRY/CN_USERNAME/CN_PASSWORD）
- 不想脚本自动改 Nginx：设 `UPSTREAM_SWITCH=manual`，脚本会停在“提示手工切流”的步骤

