# 平台对接：查看备份报表（Docker 部署）

目标：在平台中查看备份执行情况（成功/失败、时间、大小、远端地址等）。脚本已在服务器生成 JSON 报表，平台侧通过应用读取并输出 DTO（后续由 API 层对外暴露）。

宿主机报表目录：`/www/project/qiaoya/backup/reports`

## 1. 容器挂载（Docker / Compose）

将宿主机报表目录挂到容器内只读路径（推荐 `/data/db-backups/reports`）。

Docker 示例：
```bash
docker run -d \
  -v /www/project/qiaoya/backup/reports:/data/db-backups/reports:ro \
  -e BACKUP_REPORTS_DIR=/data/db-backups/reports \
  -p 8080:8080 \
  your-image:tag
```

Docker Compose 示例：
```yaml
services:
  community-backend:
    image: your-image:tag
    ports:
      - "8080:8080"
    environment:
      BACKUP_REPORTS_DIR: /data/db-backups/reports
    volumes:
      - /www/project/qiaoya/backup/reports:/data/db-backups/reports:ro
```

说明：
- `:ro` 只读挂载，平台仅读取不写入
- 建议确保容器内用户对挂载目录有读取权限（Linux 上注意宿主机文件权限/属主）

## 2. 应用配置（application.yml 或环境变量）

支持通过 yml 或 env 注入，默认值与容器路径一致。

`application.yml` 示例：
```yaml
backup:
  enabled: true
  reports-dir: ${BACKUP_REPORTS_DIR:/data/db-backups/reports}
```

等价的环境变量：
- `BACKUP_ENABLED=true`
- `BACKUP_REPORTS_DIR=/data/db-backups/reports`

## 3. 应用内实现（已提供骨架）

- 配置类：`src/main/java/org/xhy/community/infrastructure/config/BackupProperties.java:1`
  - `backup.enabled`、`backup.reports-dir`
- 读取器：`src/main/java/org/xhy/community/infrastructure/service/backup/BackupReportReader.java:1`
  - 从 `reports-dir` 读取 `*.json`，解析并按时间倒序
- DTO：`src/main/java/org/xhy/community/application/ops/dto/BackupJobDTO.java:1`
- Assembler：`src/main/java/org/xhy/community/application/ops/assembler/BackupAssembler.java:1`
- 应用服务：`src/main/java/org/xhy/community/application/ops/service/BackupAppService.java:1`
  - `getLatest()`：返回最近一次备份
  - `listReports(pageNum, pageSize, status)`：分页/状态筛选

后续若开放 API，只需在 Controller 层调用 `BackupAppService` 并返回 DTO。

已新增管理端 Controller（可直接使用）：

- `src/main/java/org/xhy/community/interfaces/ops/controller/AdminBackupController.java:1`
  - 路由前缀：`/api/admin/backup`
  - `GET /latest` → 最新备份：`BackupJobDTO`
  - `GET /list` → 分页列表：`IPage<BackupJobDTO>`（参数：`pageNum`、`pageSize`、`status`）
  - 请求对象：`src/main/java/org/xhy/community/interfaces/ops/request/BackupQueryRequest.java:1`（继承 `PageRequest`）

## 4. 最小使用示例（调用应用服务）

```java
@Service
public class SomeFacade {
    private final BackupAppService backupAppService;
    public SomeFacade(BackupAppService backupAppService) { this.backupAppService = backupAppService; }

    public BackupJobDTO latest() { return backupAppService.getLatest(); }
}
```

Controller（如需）：
```java
@RestController
@RequestMapping("/api/admin/backup")
public class AdminBackupController {
    private final BackupAppService backupAppService;
    public AdminBackupController(BackupAppService backupAppService) { this.backupAppService = backupAppService; }

    @GetMapping("/latest")
    public BackupJobDTO latest() { return backupAppService.getLatest(); }

    @GetMapping("/list")
    public List<BackupJobDTO> list(@RequestParam Integer pageNum, @RequestParam Integer pageSize,
                                   @RequestParam(required = false) String status) {
        return backupAppService.listReports(pageNum, pageSize, status);
    }
}
```

（根据当前“暂不实现 API”规范，可后续再落地 Controller。）

（已落地 AdminBackupController，可直接调用上述两个接口。）

## 5. 常见问题

- 平台读不到报表：
  - 检查 Docker 挂载是否生效（容器内 `ls /data/db-backups/reports`）
  - 校验 `BACKUP_REPORTS_DIR` 是否与挂载路径一致
- JSON 解析失败：
  - 单个报表损坏会被跳过；查看服务器端日志与生成流程
- 时区/排序：
  - 脚本使用 UTC 时间戳；读取器按 `finishedAt` 倒序

## 6. 安全建议

- 只读挂载报表目录，避免平台误写
- 报表不含敏感凭据，若需脱敏可在脚本端控制字段
