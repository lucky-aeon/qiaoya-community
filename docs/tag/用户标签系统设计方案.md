# 用户标签系统设计方案（Tag System）

状态：设计稿（可落地）  
最后更新：2025-10-02  
适用范围：通用用户标签/徽章/成就发放与展示；首批落地“课程完成发放标签”  
术语口径：请先阅读 docs/glossary.md（分层职责、权限、解锁等）  
导航：已纳入 docs/README.md 的索引，请从“课程/横切能力”进入

---

## 1. 背景与目标
- 背景：现有“课程证书（course_certificates）”过于特化，后续还需颁发“成就/身份/活动”类标识。
- 目标：抽象为统一的“用户标签/徽章系统”。
  - 用于：课程完成、里程碑（积分/答题/打卡）、身份（讲师/版主）、活动参与等。
  - 统一发放/撤销/查询，统一前台展示。
  - 与具体业务对象（课程/专题/活动）可绑定；首批覆盖“课程完成 = 发课程完成标签”。

不在本次范围：规则引擎的通用化（先用简单事件 + 绑定映射发放），复杂评分/覆盖率方案（另文）。

---

## 2. 分层与职责（DDD）
- Application：编排流程、事务、DTO/Assembler；仅调用 Domain Service。  
- Domain：标签定义、绑定、授予/撤销的核心规则与持久化；幂等发放。  
- Infrastructure：数据库迁移、缓存、类型转换、日志与监控。  
- Interfaces：用户标签查询、管理员定义/发放/撤销接口；事件监听入口可在 Application/Infrastructure 触发。

---

## 3. 数据模型（PostgreSQL）
> 命名与字段风格与项目一致（`id VARCHAR(36)`, `create_time`, `update_time`, `deleted_at TIMESTAMP NULL`）。

### 3.1 标签定义表 `tag_definitions`
- 含义：标签“是什么”（定义与展示信息）。
- 字段（建议）
  - `id`：主键
  - `code`：标签编码，唯一（如 `COURSE_COMPLETED_21`）
  - `name`：标签名称（如“完成课程：Agent 实战课”）
  - `category`：类别（ACHIEVEMENT/IDENTITY/EVENT…）
  - `icon_url`：图标（前台展示）
  - `description`：描述文案
  - `public_visible`：是否对用户可见
  - `unique_per_user`：同一用户是否仅允许一张（通常 true）
  - `enabled`：启用/禁用
  - `create_time / update_time / deleted_at`
- 约束与索引
  - `UNIQUE(code)`（uk_tag_code）
  - `idx_tag_enabled(enabled)`（可选）

### 3.2 标签绑定表 `tag_scopes`
- 含义：一个标签与哪些业务对象绑定（如“完成课程{21}”的标签与课程 21 绑定）。
- 字段
  - `id`：主键
  - `tag_id`：FK -> `tag_definitions.id`
  - `target_type`：枚举字符串（如 COURSE/CHAPTER/POST/ACTIVITY…）
  - `target_id`：对象ID（如课程ID）
  - `create_time / update_time / deleted_at`
- 约束与索引
  - `UNIQUE(tag_id, target_type, target_id) WHERE deleted_at IS NULL`（uk_tag_scope）
  - `idx_scope_target(target_type, target_id)`（反查）

### 3.3 用户标签表 `user_tag_assignments`
- 含义：记录“哪个用户拥有哪些标签（何时、因为什么）”。
- 字段
  - `id`：主键
  - `user_id`：用户ID
  - `tag_id`：FK -> `tag_definitions.id`
  - `status`：ISSUED/REVOKED/EXPIRED
  - `issued_at`：发放时间
  - `revoked_at`：撤销时间（可空）
  - `expire_at`：过期时间（可空）
  - `source_type`：标签来源（COURSE_COMPLETION/MANUAL/ORDER/…）
  - `source_id`：来源对象ID（如课程ID/订单ID）
  - `meta JSONB`：扩展（期次、批次、凭证号等）
  - `create_time / update_time / deleted_at`
- 约束与索引
  - `UNIQUE(user_id, tag_id) WHERE deleted_at IS NULL`（uk_user_tag，满足“每用户每标签一条有效记录”）
  - `idx_user_tags(user_id)`，`idx_tag_users(tag_id)`

> 如果未来要“配置化自动发放”，可新增 `tag_rules`（rule_type + rule_config JSONB + enabled/priority）。

---

## 4. 事件与发放流程
- 课程完成（CourseCompletedEvent）→ TagDomainService：
  1) 根据 `target_type=COURSE & target_id=courseId` 查 `tag_scopes` 找到关联的 `tag_id`
  2) 幂等发放：写入/更新 `user_tag_assignments`（status=ISSUED, issued_at=now, source_type=COURSE_COMPLETION, source_id=courseId）
  3) 可选：发送站内通知（“恭喜获得标签：完成课程《xxx》”）

> 初期课程完成判定可沿用现状；后续再将“视频章节完成”升级为“覆盖率阈值 + 最小观看时长”AND 规则，不影响本标签系统。

---

## 5. 接口草案（Interfaces）
- 用户端
  - `GET /api/user/tags`：我的标签列表（支持按 category/public_visible 过滤）
  - `GET /api/user/tags/{tagId}`：标签详情（可含来源、时间、meta）
- 管理端
  - `POST /api/admin/tags`：创建标签定义（含 icon、category、unique_per_user 等）
  - `PUT /api/admin/tags/{id}`：更新标签定义
  - `GET /api/admin/tags`：查询标签定义
  - `POST /api/admin/tags/{id}/scopes`：绑定业务对象（courseId 等）
  - `DELETE /api/admin/tags/{id}/scopes/{scopeId}`：解绑
  - `POST /api/admin/tags/{id}/assign`：手动发放给用户（source_type=MANUAL）
  - `POST /api/admin/tags/{id}/revoke`：撤销用户标签

> DTO 命名与 Assembler 参照现有规范（application 层 Assembler 静态方法）；权限与分层与 docs/glossary.md 保持一致。

---

## 6. 前台展示与交互（建议）
- 我的徽章/标签：分组展示（成就/身份/活动），支持 hover 查看描述与来源。
- “课程完成”类标签：在课程详情/我的学习中样式化为“证书卡片”，点击可跳回课程。
- 可见性：标签定义支持 `public_visible`，隐藏内部标签（如风控标记）。

---

## 7. 迁移与兼容
- 当前处于开发阶段，不涉及历史数据迁移；暂不考虑从 `course_certificates` 迁移旧数据。
- 如未来产生存量数据，需要单独制定迁移方案（标签定义批量生成、范围绑定、历史授予回填等）。

---

## 8. 验收标准
- 课程完成后触发标签发放（幂等、多次完成不重复发）
- 我的标签列表可正确展示；课程完成标签可跳转课程详情
- 管理员可创建“课程完成标签”并绑定课程；手动发放/撤销生效
- 查询量大时可通过 `idx_user_tags/idx_tag_users/idx_scope_target` 保证性能

---

## 9. 关键代码路径（建议落点）
- 迁移：`src/main/resources/db/migration/V4x__Create_tag_tables.sql`（新增 3 张表）
- Domain：`domain/tag/service/TagDomainService.java`（发放/撤销/查询）
- Repository：`domain/tag/repository/*`（三个表的 BaseMapper）
- Application：`application/tag/service/*`（编排与 DTO/Assembler）
- 事件监听：在课程完成处发布 CourseCompletedEvent，由 Application/Infrastructure 监听并调用 TagDomainService 发放

---

## 10. 后续扩展
- `tag_rules`：将签到、积分里程碑、答题成绩、活动参与等配置为自动发放
- 标签层级（Lv1/Lv2）、合并/升级（撤旧发新）
- 标签依赖与组合（获得 A+B 自动授予 C）
- 前台“未解锁成就”灰显与引导

> 本文档遵循 docs/README.md 的状态与术语规范；如与其它文档描述冲突，以 docs/glossary.md 的口径为准。
