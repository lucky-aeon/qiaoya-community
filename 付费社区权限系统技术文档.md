# 敲鸭社区付费权限系统 - 事件驱动五领域架构设计

## 1. 系统概述

### 1.1 业务背景
敲鸭社区采用分层付费运营模式：
- **套餐制度**：管理员自定义套餐权限类型，用户通过CDK激活订阅
- **个人授权**：管理员直接给用户绑定特定课程权限
- **CDK统一激活**：支持套餐CDK和课程CDK两种类型，用户体验统一
- **事件驱动架构**：基于领域事件实现各领域解耦协作

### 1.2 核心特性
- 五领域架构：套餐管理、订单、订阅、权限、用户五个领域职责清晰
- 事件驱动：订阅领域发布领域事件，其他领域异步监听处理
- CDK统一激活：套餐CDK和课程CDK统一激活流程，用户体验一致
- 双重权限模型：套餐权限（菜单+课程）+ 用户个人购买权限
- 权限叠加：套餐权限和个人权限可以叠加
- 永久购买制：用户个人购买的课程永久有效
- 完整交易记录：所有权限获取都有对应订单记录，支持追溯

## 2. 领域边界划分（事件驱动五领域架构）

### 2.1 套餐管理领域 (Plan Management Domain)
**职责范围：**
- 套餐产品定义和管理
- 套餐权限配置（菜单权限 + 课程权限）
- CDK生成和管理（支持套餐CDK和课程CDK）
- 套餐规则和策略管理

**核心聚合：**
- **套餐聚合 (SubscriptionPlan Aggregate)**
  - 套餐实体：name, level, validity_months, price, status
  - 套餐课程关联：subscription_plan_courses 表
  - 套餐菜单关联：subscription_plan_menus 表
  - 业务规则：套餐升级判断、权限配置验证

- **CDK聚合 (CDK Aggregate)**
  - CDK实体：code, cdk_type(SUBSCRIPTION_PLAN/COURSE), target_id, batch_id, status
  - 业务规则：唯一性检查、批量生成、类型验证

**领域服务：**
- 套餐配置服务：管理套餐的菜单和课程权限配置
- CDK管理服务：批量生成不同类型的CDK、CDK验证
- 套餐规则服务：套餐升级判断、价格计算

**事件监听：**
- CDKActivatedEvent → 更新CDK状态为已使用

### 2.2 订单领域 (Order Domain)
**职责范围：**
- 所有交易记录和流水管理
- 订单状态和生命周期管理
- 未来支付集成预留

**核心聚合：**
- **订单聚合 (Order Aggregate)**
  - 订单实体：user_id, order_type, total_amount, status, created_time
  - 订单类型：PLAN_ACTIVATION(套餐CDK激活)、COURSE_ACTIVATION(课程CDK激活)、DIRECT_PURCHASE(直接购买)
  - 订单项：order_items(订单明细)
  - 业务规则：订单创建、状态流转、支付验证

- **激活记录聚合 (ActivationRecord Aggregate)**
  - 激活实体：cdk_code, cdk_type, user_id, order_id, activation_time
  - 业务规则：激活记录追溯、历史查询

**领域服务：**
- 订单创建服务：统一处理各种购买订单
- 订单状态服务：订单生命周期管理
- 激活记录服务：管理激活历史

**事件监听：**
- CDKActivatedEvent → 创建激活订单记录
- SubscriptionActivatedEvent → 创建订阅订单
- CourseCDKActivatedEvent → 创建课程激活订单

### 2.3 订阅领域 (Subscription Domain) ⭐ 核心领域
**职责范围：**
- **接收用户CDK激活请求（核心入口）**
- 用户订阅生命周期管理
- 发布CDK激活相关领域事件
- "我的订阅"查询服务
- 订阅状态管理和续费预留

**核心聚合：**
- **用户订阅聚合 (UserSubscription Aggregate)**
  - 订阅实体：user_id, subscription_plan_id, start_time, end_time, status, source_order_id
  - 业务规则：有效期判断、到期检查、来源追溯、订阅状态管理

**领域服务：**
- **CDK激活服务（核心）**：处理用户CDK激活请求，验证并发布事件
- 订阅查询服务：我的订阅列表、订阅详情、剩余天数计算
- 订阅管理服务：订阅创建、更新、过期处理
- 订阅续费服务：为未来续费功能预留

**发布的领域事件：**
- CDKActivatedEvent：CDK激活基础事件
- SubscriptionActivatedEvent：套餐订阅激活事件
- CourseCDKActivatedEvent：课程CDK激活事件

### 2.4 权限领域 (Permission Domain)
**职责范围：**
- 用户课程权限存储和管理
- 课程访问权限验证（无需跨领域调用）
- 权限查询和统计
- 从订阅事件同步权限数据

**核心聚合：**
- **用户课程聚合 (UserCourse Aggregate)**
  - 权限实体：user_id, course_id, source_type, source_order_id, source_subscription_id, created_time
  - 来源类型：SUBSCRIPTION(套餐权限)、DIRECT_PURCHASE(直接购买)、CDK_ACTIVATION(CDK激活)
  - 业务规则：永久有效性、来源追溯、重复权限处理

**领域服务：**
- **权限验证服务（核心）**：统一的课程访问权限判断逻辑
- 权限同步服务：从订阅事件同步权限数据
- 权限查询服务：获取用户课程权限列表
- 权限清理服务：处理过期权限、权限回收

**事件监听：**
- SubscriptionActivatedEvent → 同步套餐包含的课程权限
- CourseCDKActivatedEvent → 添加单个课程权限

### 2.5 用户领域 (User Domain)
**职责范围：**
- 用户基本信息管理
- 用户状态和设备管理

**现有聚合：**
- **用户聚合 (User Aggregate)**
  - 用户实体：已存在的 UserEntity
  - 业务规则：用户状态管理、设备数限制

## 3. CDK统一激活系统设计 🎯

### 3.1 用户CDK激活请求入口
```
用户操作：输入CDK码激活
    ↓
API层：POST /api/user/subscription/activate-cdk
    ↓
应用层：SubscriptionAppService.activateCDK(userId, cdkCode) ⭐
    ↓
订阅领域：SubscriptionDomainService
```

### 3.2 CDK类型设计
```
CDK类型分类：
├── SUBSCRIPTION_PLAN：套餐CDK
│   ├── target_id指向套餐ID
│   ├── 激活后获得套餐订阅（有期限）
│   └── 自动同步套餐包含的所有课程和菜单权限
└── COURSE：课程CDK  
    ├── target_id指向课程ID
    ├── 激活后获得单个课程权限（永久有效）
    └── 不涉及菜单权限
```

### 3.3 事件驱动的CDK激活流程
```
用户输入CDK码
    ↓
订阅领域：CDK激活服务
    ├── 1. 验证CDK有效性（调用套餐管理领域）
    ├── 2. 根据cdk_type分别处理：
    │   ├── SUBSCRIPTION_PLAN → 套餐激活流程
    │   │   ├── 创建用户订阅记录(user_subscriptions)
    │   │   ├── 发布SubscriptionActivatedEvent
    │   │   └── 发布CDKActivatedEvent
    │   └── COURSE → 课程激活流程
    │       ├── 发布CourseCDKActivatedEvent
    │       └── 发布CDKActivatedEvent
    └── 3. 返回激活结果给用户

异步事件处理（并行执行）：
    ├── 订单领域 → 创建激活订单记录
    ├── 权限领域 → 同步课程权限
    └── 套餐管理领域 → 更新CDK状态
```

## 4. 领域事件设计 🔥

### 4.1 CDK激活基础事件
```java
public class CDKActivatedEvent {
    private String userId;
    private String cdkCode;
    private CDKType cdkType;  // SUBSCRIPTION_PLAN / COURSE
    private String targetId;   // 套餐ID或课程ID
    private LocalDateTime activatedTime;
    
    // 所有CDK激活都会发布此事件
}
```

### 4.2 套餐订阅激活事件
```java
public class SubscriptionActivatedEvent {
    private String userId;
    private String subscriptionId;
    private String planId;
    private LocalDateTime startTime;
    private LocalDateTime endTime;
    private String sourceOrderId;
    
    // 套餐CDK激活时发布，权限领域监听同步课程权限
}
```

### 4.3 课程CDK激活事件
```java
public class CourseCDKActivatedEvent {
    private String userId;
    private String courseId;
    private String cdkCode;
    private LocalDateTime activatedTime;
    
    // 课程CDK激活时发布，权限领域监听添加课程权限
}
```

### 4.4 事件监听器设计
```java
// 订单领域事件监听器
@EventListener
public class OrderEventListener {
    
    @Async
    public void handleCDKActivated(CDKActivatedEvent event) {
        // 创建激活订单记录，记录交易流水
        orderDomainService.createActivationOrder(event);
    }
}

// 权限领域事件监听器
@EventListener  
public class PermissionEventListener {
    
    @Async
    public void handleSubscriptionActivated(SubscriptionActivatedEvent event) {
        // 套餐激活：同步套餐包含的课程权限
        permissionDomainService.syncSubscriptionCourses(event);
    }
    
    @Async
    public void handleCourseCDKActivated(CourseCDKActivatedEvent event) {
        // 课程CDK激活：直接添加课程权限
        permissionDomainService.addCoursePermission(event);
    }
}

// 套餐管理领域事件监听器
@EventListener
public class PlanManagementEventListener {
    
    @Async
    public void handleCDKActivated(CDKActivatedEvent event) {
        // 更新CDK状态为已使用
        cdkDomainService.markAsUsed(event.getCdkCode(), event.getUserId());
    }
}
```

## 5. 领域间协作关系

### 5.1 同步调用关系
- **订阅领域 → 套餐管理领域**：CDK验证时查询CDK详情和目标信息
- **权限领域 → 套餐管理领域**：权限验证时查询套餐包含的课程配置（通过缓存优化）

### 5.2 事件驱动关系
```
订阅领域（事件发布者）
    ├── CDKActivatedEvent
    ├── SubscriptionActivatedEvent  
    └── CourseCDKActivatedEvent
    
监听者：
    ├── 订单领域：监听CDK激活事件创建订单记录
    ├── 权限领域：监听订阅事件同步权限
    └── 套餐管理领域：监听CDK激活更新状态
```

### 5.3 用户请求流转
```
用户CDK激活：
用户 → SubscriptionAppService → SubscriptionDomainService → 事件发布 → 异步处理

用户查询订阅：
用户 → SubscriptionAppService → SubscriptionDomainService → 直接返回

用户查询课程权限：
用户 → CourseAppService → PermissionDomainService → 直接返回

课程访问验证：
前端/API → PermissionDomainService → 直接验证（无需跨领域）
```

## 6. 数据模型分布

### 6.1 套餐管理领域
```sql
subscription_plans (套餐定义)
├── id, name, level, validity_months, price, status
└── 纯产品信息，不涉及用户数据

subscription_plan_courses (套餐-课程绑定)
├── subscription_plan_id, course_id
└── 定义套餐包含哪些课程

subscription_plan_menus (套餐-菜单绑定)
├── subscription_plan_id, menu_id  
└── 定义套餐可访问哪些菜单

cdk_codes (CDK码表)
├── id, code, cdk_type(SUBSCRIPTION_PLAN/COURSE)
├── target_id, batch_id, status, created_time
├── used_by_user_id, used_time
└── 统一管理套餐CDK和课程CDK
```

### 6.2 订单领域
```sql
orders (订单主表)
├── id, user_id, order_type, total_amount
├── status, created_time, updated_time
└── 统一记录所有交易行为

order_items (订单明细)
├── order_id, item_type(PLAN/COURSE)
├── item_id, quantity, price
└── 支持套餐订单和课程订单

activation_records (激活记录)
├── id, cdk_code, cdk_type, user_id
├── order_id, activation_time, status
└── CDK激活历史记录，支持追溯
```

### 6.3 订阅领域
```sql
user_subscriptions (用户订阅)
├── id, user_id, subscription_plan_id
├── start_time, end_time, status
├── source_order_id, created_time, updated_time
└── 用户订阅记录，可追溯来源订单
```

### 6.4 权限领域
```sql
user_courses (用户课程权限)
├── id, user_id, course_id, created_time
├── source_type(SUBSCRIPTION/DIRECT_PURCHASE/CDK_ACTIVATION)
├── source_order_id, source_subscription_id
└── 支持多种来源的课程权限，可追溯来源
```

### 6.5 用户领域
```sql
users (用户基础信息)
├── 已存在的用户实体结构
└── 提供用户基础数据
```

## 7. 权限判断流程（优化版）

### 7.1 课程访问权限判断
```
用户访问课程请求
    ↓
权限领域：权限验证服务 ⭐
    ├── 1. 查询用户直接相关权限 (user_courses)
    │   ├── source_type=DIRECT_PURCHASE → 允许访问（永久）
    │   ├── source_type=CDK_ACTIVATION → 允许访问（永久）  
    │   └── source_type=SUBSCRIPTION → 检查关联订阅有效期
    ├── 2. 检查订阅权限（如有SUBSCRIPTION类型权限）
    │   ├── 通过source_subscription_id查询订阅状态
    │   └── 订阅有效 → 允许访问
    └── 3. 无权限 → 拒绝访问

注：权限验证完全在权限领域内完成，性能最优
```

### 7.2 菜单权限判断
```
用户登录后获取菜单权限
    ↓  
订阅领域：菜单权限查询服务
    ├── 1. 查询用户有效订阅 (user_subscriptions)
    ├── 2. 查询套餐菜单权限 (缓存查询套餐管理领域)
    └── 3. 返回用户可访问的菜单列表
```

### 7.3 权限叠加规则
```
用户最终课程权限 = 
    个人购买课程（永久有效，source_type=DIRECT_PURCHASE）
    ∪
    CDK激活课程（永久有效，source_type=CDK_ACTIVATION）
    ∪  
    套餐包含课程（订阅有效期内，source_type=SUBSCRIPTION）
```

## 8. 业务场景示例

### 8.1 用户激活套餐CDK场景（事件驱动）
```
用户激活"基础版"套餐CDK：
├── 请求：POST /api/user/subscription/activate-cdk {cdk: "BASIC001"}
├── 处理：SubscriptionAppService.activateCDK()
├── 订阅领域处理：
│   ├── 验证CDK有效性
│   ├── 创建用户订阅记录（12个月有效期）
│   ├── 发布SubscriptionActivatedEvent
│   └── 发布CDKActivatedEvent
├── 异步事件处理：
│   ├── 权限领域 → 同步3门基础课程权限
│   ├── 订单领域 → 创建PLAN_ACTIVATION订单
│   └── 套餐管理领域 → 标记CDK已使用
└── 结果：用户获得基础菜单权限 + 3门课程权限（12个月有效）
```

### 8.2 用户激活课程CDK场景（事件驱动）
```
用户激活"高级Java架构"课程CDK：
├── 请求：POST /api/user/subscription/activate-cdk {cdk: "JAVA001"}
├── 处理：SubscriptionAppService.activateCDK()
├── 订阅领域处理：
│   ├── 验证CDK有效性
│   ├── 发布CourseCDKActivatedEvent
│   └── 发布CDKActivatedEvent
├── 异步事件处理：
│   ├── 权限领域 → 添加单个课程权限（永久）
│   ├── 订单领域 → 创建COURSE_ACTIVATION订单
│   └── 套餐管理领域 → 标记CDK已使用
└── 结果：用户获得该课程的永久访问权限
```

### 8.3 用户查看我的订阅场景
```
用户查看订阅列表：
├── 请求：GET /api/user/subscription/list
├── 处理：SubscriptionAppService.getMySubscriptions(userId)
├── 订阅领域查询：
│   ├── 查询用户所有订阅记录
│   ├── 计算剩余天数、到期状态
│   ├── 关联套餐信息
│   └── 返回订阅DTO列表
└── 结果：返回用户订阅历史、当前状态、到期时间等信息
```

### 8.4 管理员直接购买课程场景
```
管理员给用户购买"微服务架构"课程：
├── 请求：POST /api/admin/user/{userId}/purchase-course
├── 处理：AdminCourseAppService.purchaseCourseForUser()
├── 订单领域处理：
│   ├── 创建DIRECT_PURCHASE订单
│   └── 直接调用权限领域同步权限
├── 权限领域处理：
│   └── 创建课程权限（source_type=DIRECT_PURCHASE，永久有效）
└── 结果：用户获得该课程的永久访问权限
```

## 9. API接口设计规范

### 9.1 用户订阅相关API
```java
// 订阅管理
POST /api/user/subscription/activate-cdk        // CDK激活 → SubscriptionAppService
GET  /api/user/subscription/list                // 我的订阅列表 → SubscriptionAppService
GET  /api/user/subscription/{id}                // 订阅详情 → SubscriptionAppService
POST /api/user/subscription/{id}/renew          // 续费（未来功能）

// 课程权限相关
GET  /api/user/courses                          // 我的课程列表 → CourseAppService
POST /api/user/courses/{id}/access-check        // 检查课程访问权限 → CourseAppService
```

### 9.2 管理员相关API
```java
// CDK管理
POST /api/admin/cdk/generate                    // 批量生成CDK → AdminCDKAppService
GET  /api/admin/cdk/list                        // CDK列表查询
POST /api/admin/cdk/{id}/disable                // 禁用CDK

// 直接购买
POST /api/admin/user/{userId}/purchase-course   // 给用户购买课程 → AdminCourseAppService
POST /api/admin/user/{userId}/purchase-plan     // 给用户购买套餐
```

## 10. 系统核心优势

### 10.1 事件驱动架构优势
1. **解耦合**：各领域通过事件通信，不直接依赖，易于维护
2. **高性能**：异步事件处理，提高用户响应速度
3. **可扩展**：新增功能只需监听相关事件，不影响现有代码
4. **事务一致性**：通过事件实现最终一致性，保证数据完整

### 10.2 五领域架构优势
1. **职责清晰**：每个领域专注自己的核心业务，边界明确
2. **独立部署**：各领域可独立开发、测试、部署
3. **易于理解**：业务逻辑集中在对应领域，符合业务直觉
4. **便于协作**：团队可按领域分工，并行开发

### 10.3 CDK统一激活系统优势
1. **用户体验一致**：所有CDK激活流程统一，操作简单
2. **管理灵活**：支持套餐CDK和课程CDK，满足不同业务需求
3. **扩展性强**：未来可以轻松添加新的CDK类型
4. **追溯完整**：每个权限都可追溯到激活来源

### 10.4 权限验证优化
1. **性能提升**：权限验证无需跨领域查询，响应更快
2. **逻辑集中**：所有权限逻辑在权限领域内，维护方便
3. **状态清晰**：权限状态和有效期管理清晰明确
4. **来源追溯**：每个权限都可追溯到来源订单或订阅

## 11. 技术实现要点

### 11.1 事件发布和监听
```java
// 事件发布（在订阅领域服务中）
@Service
public class SubscriptionDomainService {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    public void activateSubscriptionCDK(String userId, CDKEntity cdk) {
        // 创建订阅记录
        UserSubscriptionEntity subscription = createSubscription(userId, cdk);
        
        // 发布事件
        SubscriptionActivatedEvent event = new SubscriptionActivatedEvent(
            userId, subscription.getId(), cdk.getTargetId(), 
            subscription.getStartTime(), subscription.getEndTime()
        );
        eventPublisher.publishEvent(event);
        
        CDKActivatedEvent cdkEvent = new CDKActivatedEvent(
            userId, cdk.getCode(), cdk.getType(), cdk.getTargetId()
        );
        eventPublisher.publishEvent(cdkEvent);
    }
}

// 异步事件监听（启用异步支持）
@EnableAsync
@Configuration
public class AsyncConfig {
    
    @Bean
    public TaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(4);
        executor.setMaxPoolSize(8);
        executor.setQueueCapacity(100);
        return executor;
    }
}
```

### 11.2 缓存优化
```java
// 套餐配置缓存（减少跨领域调用）
@Cacheable("subscription-plan-courses")
public List<String> getPlanCourseIds(String planId) {
    return subscriptionPlanRepository.getCourseIds(planId);
}

// 权限验证时使用缓存
public boolean hasAccessToCourse(String userId, String courseId) {
    // 先检查直接权限（user_courses表）
    // 再检查订阅权限（使用缓存的套餐配置）
}
```

### 11.3 事务处理
```java
// 订阅领域的事务边界
@Transactional
public CDKActivationResult activateCDK(String userId, String cdkCode) {
    // 1. 验证CDK
    // 2. 创建订阅记录（如果是套餐CDK）
    // 3. 发布事件（事务提交后异步处理）
    return result;
}

// 事件监听器的事务处理
@Transactional
@Async
public void handleSubscriptionActivated(SubscriptionActivatedEvent event) {
    // 权限同步逻辑
}
```

## 12. 总结

### 12.1 核心设计理念
- **事件驱动五领域架构**：套餐管理、订单、订阅、权限、用户五个领域通过事件协作
- **订阅为中心**：用户CDK激活本质是订阅行为，由订阅领域统一处理
- **异步解耦**：通过领域事件实现各领域异步协作，提高性能和可扩展性
- **完整追溯**：所有权限获取都有完整的事件和订单追溯链路
- **统一用户体验**：CDK激活、订阅查询等用户操作体验一致

### 12.2 关键创新点
1. **事件驱动架构**：领域间通过事件通信，实现真正的解耦
2. **订阅领域独立**：专门的订阅领域处理用户订阅生命周期
3. **CDK统一激活**：套餐CDK和课程CDK统一激活入口和处理流程
4. **异步权限同步**：权限同步通过事件异步处理，提高响应速度
5. **完整业务闭环**：从CDK激活到权限生效的完整业务链路

### 12.3 系统优势总结
1. **架构先进**：事件驱动架构符合微服务和DDD最佳实践
2. **性能优异**：异步处理和缓存优化保证系统高性能
3. **扩展性强**：新增功能只需发布/监听事件，易于扩展
4. **维护性好**：各领域职责清晰，代码组织合理
5. **用户体验佳**：统一的激活流程和快速的响应速度
6. **业务完整**：支持套餐订阅、课程购买、权限管理的完整业务场景

这个事件驱动的五领域架构设计既满足了敲鸭社区当前的业务需求，又为未来的功能扩展（如支付、营销、数据分析等）提供了坚实的架构基础，是一个既实用又前瞻的技术方案。通过事件驱动机制，各领域真正实现了解耦，提高了系统的可维护性和可扩展性。